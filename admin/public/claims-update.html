<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extended Claims Update - SSO-Authen V.3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/admin-responsive.css" rel="stylesheet">
    <style>
        * { font-family: 'Bai Jamjuree', sans-serif; }
        body { font-family: 'Bai Jamjuree', sans-serif; background-color: #f8f9fa; }
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 280px; background: #2c3e50; color: white; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 1.5rem; background: #34495e; border-bottom: 1px solid #445566; }
        .main-content { margin-left: 280px; padding: 2rem; }
        .nav-link { color: #ecf0f1; padding: 0.5rem 1rem; border-radius: 0.375rem; margin: 0.125rem 0; text-decoration: none; font-size: 0.875rem; display: block; transition: all 0.2s; }
        .nav-link:hover { background-color: #34495e; color: white; }
        .nav-link.active { background-color: #3498db; color: white; }
        .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem 0; margin: -2rem -2rem 2rem -2rem; border-radius: 0 0 1rem 1rem; }
        .content-card { background: white; border-radius: 0.5rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .code-block { background: #2c3e50; color: #ecf0f1; border-radius: 0.5rem; padding: 1.5rem; margin: 1rem 0; overflow-x: auto; }
        .section-content { display: none; }
        .section-content.active { display: block; }
        .provider-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; margin: 0.25rem; }
        .provider-psu { background: #27ae60; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-certificate"></i> Extended Claims</h4>
            <small>SSO-Authen V.3 - อัปเดต: 2025-10-22</small>
        </div>
        <div class="p-3">
            <a href="#overview" class="nav-link active" onclick="showSection('overview')"><i class="fas fa-info-circle"></i> สรุป</a>
            <a href="#extended" class="nav-link" onclick="showSection('extended')"><i class="fas fa-database"></i> Extended Claims</a>
            <a href="#provider" class="nav-link" onclick="showSection('provider')"><i class="fas fa-exchange-alt"></i> Provider Mapping</a>
            <a href="#database" class="nav-link" onclick="showSection('database')"><i class="fas fa-table"></i> Database</a>
            <a href="#usage" class="nav-link" onclick="showSection('usage')"><i class="fas fa-code"></i> การใช้งาน</a>
            <a href="#faq" class="nav-link" onclick="showSection('faq')"><i class="fas fa-question"></i> FAQ</a>
        </div>
    </div>

    <div class="main-content">
        <div class="hero-section">
            <div class="container">
                <h1><i class="fas fa-certificate"></i> Claims System Update</h1>
                <p class="lead">Complete Extended Claims Documentation</p>
            </div>
        </div>

        <div id="overview" class="section-content active">
            <div class="content-card">
                <h2><i class="fas fa-info-circle text-primary"></i> สรุปการอัปเดต</h2>
                <p>เพิ่มการรองรับ <strong>Extended Claims (14 ฟิลด์)</strong> จาก PSU SSO และ OIDC Providers อื่นๆ</p>
                <div class="alert alert-success">
                    <h5>✅ สิ่งที่ทำสำเร็จ</h5>
                    <ul>
                        <li>อัปเดต Provider Configurations ทั้ง 5 ไฟล์</li>
                        <li>อัปเดต Database Schema (admin_users)</li>
                        <li>สร้าง Migration Scripts</li>
                        <li>อัปเดต User Handler Examples</li>
                        <li>อัปเดตเอกสาร API</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="extended" class="section-content">
            <div class="content-card">
                <h2><i class="fas fa-database text-primary"></i> Extended Claims Schema</h2>
                <p>ระบบรองรับข้อมูลผู้ใช้ทั้งหมด <strong>14 ฟิลด์</strong>:</p>
                
                <h4>Basic Claims (7 ฟิลด์)</h4>
                <ul>
                    <li><code>id</code> - รหัสผู้ใช้</li>
                    <li><code>username</code> - ชื่อผู้ใช้</li>
                    <li><code>name</code> - ชื่อ-นามสกุล</li>
                    <li><code>firstName</code> - ชื่อ</li>
                    <li><code>lastName</code> - นามสกุล</li>
                    <li><code>email</code> - อีเมล</li>
                    <li><code>department</code> - ภาควิชา/คณะ</li>
                </ul>

                <h4 class="mt-4">Extended Claims (7 ฟิลด์ - PSU SSO)</h4>
                <ul>
                    <li><code>position</code> - ตำแหน่งงาน</li>
                    <li><code>campus</code> - วิทยาเขต</li>
                    <li><code>officeName</code> - ชื่อสำนักงาน</li>
                    <li><code>facultyId</code> - รหัสคณะ</li>
                    <li><code>departmentId</code> - รหัสภาควิชา</li>
                    <li><code>campusId</code> - รหัสวิทยาเขต</li>
                    <li><code>groups</code> - กลุ่มผู้ใช้ (array)</li>
                </ul>

                <div class="alert alert-info">
                    <strong>หมายเหตุ:</strong> Extended Claims จะมีค่าเฉพาะ PSU SSO เท่านั้น Providers อื่น (Google, Microsoft) จะเป็น <code>null</code>
                </div>
            </div>
        </div>

        <div id="provider" class="section-content">
            <div class="content-card">
                <h2><i class="fas fa-exchange-alt text-primary"></i> Provider Claim Mapping</h2>
                
                <h4><span class="provider-psu">PSU SSO</span></h4>
                <p>รองรับครบทั้ง 14 ฟิลด์</p>
                <div class="code-block"><pre>id           => psu_id
username     => preferred_username
name         => display_name_th
position     => position_th
campus       => campus_th
groups       => groups</pre></div>

                <h4 class="mt-4">Google / Microsoft / Auth0</h4>
                <p>รองรับเฉพาะ Basic Claims (7 ฟิลด์)</p>
                <div class="code-block"><pre>Extended Claims = null</pre></div>

                <table class="table table-bordered mt-4">
                    <thead class="table-dark">
                        <tr>
                            <th>Provider</th>
                            <th>Basic Claims</th>
                            <th>Extended Claims</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>PSU SSO</td>
                            <td>✅ ครบ 7 ฟิลด์</td>
                            <td>✅ ครบ 7 ฟิลด์</td>
                        </tr>
                        <tr>
                            <td>Google</td>
                            <td>✅ ครบ 7 ฟิลด์</td>
                            <td>❌ null</td>
                        </tr>
                        <tr>
                            <td>Microsoft</td>
                            <td>✅ ครบ 7 ฟิลด์</td>
                            <td>❌ null</td>
                        </tr>
                        <tr>
                            <td>Auth0</td>
                            <td>✅ ครบ 7 ฟิลด์</td>
                            <td>❌ null</td>
                        </tr>
                        <tr>
                            <td>Okta</td>
                            <td>✅ ครบ 7 ฟิลด์</td>
                            <td>⚠️ มีเฉพาะ groups</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="database" class="section-content">
            <div class="content-card">
                <h2><i class="fas fa-table text-primary"></i> Database Changes</h2>
                
                <h4>admin_users Table</h4>
                <p>เพิ่มคอลัมน์ใหม่ 8 คอลัมน์:</p>
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr><th>Column</th><th>Type</th><th>Description</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>position</td><td>VARCHAR(255) NULL</td><td>ตำแหน่งงาน</td></tr>
                        <tr><td>campus</td><td>VARCHAR(255) NULL</td><td>วิทยาเขต</td></tr>
                        <tr><td>office_name</td><td>VARCHAR(255) NULL</td><td>สำนักงาน</td></tr>
                        <tr><td>faculty_id</td><td>VARCHAR(50) NULL</td><td>รหัสคณะ</td></tr>
                        <tr><td>department_id</td><td>VARCHAR(50) NULL</td><td>รหัสภาควิชา</td></tr>
                        <tr><td>campus_id</td><td>VARCHAR(50) NULL</td><td>รหัสวิทยาเขต</td></tr>
                        <tr><td>groups</td><td>TEXT NULL</td><td>กลุ่มผู้ใช้ (JSON)</td></tr>
                        <tr><td>provider</td><td>VARCHAR(50) DEFAULT 'psu'</td><td>OIDC Provider</td></tr>
                    </tbody>
                </table>

                <h5 class="mt-4">วิธีรัน Migration:</h5>
                <div class="code-block"><pre>mysql -u root -p sso_authen &lt; database/migrations/add_extended_claims_to_admin_users.sql</pre></div>

                <h4 class="mt-4">Client App: users Table</h4>
                <p>แนะนำให้เพิ่มคอลัมน์เดียวกันในตาราง users ของแอปพลิเคชัน</p>
                <div class="code-block"><pre>ALTER TABLE users 
ADD COLUMN position VARCHAR(255) NULL,
ADD COLUMN campus VARCHAR(255) NULL,
ADD COLUMN office_name VARCHAR(255) NULL,
ADD COLUMN faculty_id VARCHAR(50) NULL,
ADD COLUMN department_id VARCHAR(50) NULL,
ADD COLUMN campus_id VARCHAR(50) NULL,
ADD COLUMN `groups` TEXT NULL;</pre></div>
            </div>
        </div>

        <div id="usage" class="section-content">
            <div class="content-card">
                <h2><i class="fas fa-code text-primary"></i> การใช้งาน</h2>
                
                <h4>1. อัปเดต User Handler API</h4>
                <div class="code-block"><pre>$normalizedUser = $data['normalizedUser'];

$insertStmt = $pdo->prepare("
    INSERT INTO users (
        user_id, email, name,
        position, campus, faculty_id,
        department_id, campus_id, groups
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
");

$insertStmt->execute([
    $normalizedUser['id'],
    $normalizedUser['email'],
    $normalizedUser['name'],
    $normalizedUser['position'] ?? null,
    $normalizedUser['campus'] ?? null,
    $normalizedUser['facultyId'] ?? null,
    $normalizedUser['departmentId'] ?? null,
    $normalizedUser['campusId'] ?? null,
    json_encode($normalizedUser['groups'] ?? [])
]);</pre></div>

                <h4 class="mt-4">2. จัดการ NULL Values</h4>
                <div class="code-block"><pre>// ปลอดภัย
$position = $user['position'] ?? 'ไม่ระบุ';

// SQL WHERE
WHERE faculty_id IS NOT NULL AND faculty_id = 'F01';

// Groups
$groups = json_decode($user['groups'], true) ?? [];
if (in_array('admin', $groups)) {
    // Admin access
}</pre></div>

                <h4 class="mt-4">3. Use Cases</h4>
                <ul>
                    <li><strong>Authorization:</strong> ตรวจสอบ faculty_id, department_id</li>
                    <li><strong>Personalization:</strong> แสดงข้อมูลตาม campus_id</li>
                    <li><strong>Group Management:</strong> จัดการสิทธิ์ตาม groups</li>
                </ul>
            </div>
        </div>

        <div id="faq" class="section-content">
            <div class="content-card">
                <h2><i class="fas fa-question-circle text-primary"></i> FAQ</h2>
                
                <h5>Q: ทำไมต้องเพิ่ม Extended Claims?</h5>
                <p>A: PSU SSO ให้ข้อมูลผู้ใช้ที่มากกว่า providers อื่น ช่วยทำ Authorization ที่ละเอียดยิ่งขึ้น</p>

                <h5 class="mt-3">Q: แอปของผมต้องรองรับทั้งหมดไหม?</h5>
                <p>A: ไม่จำเป็น - ถ้าใช้เฉพาะ PSU SSO ก็รองรับได้เต็มที่ แต่ต้องจัดการ NULL ถ้ารองรับหลาย providers</p>

                <h5 class="mt-3">Q: Groups เก็บเป็น JSON หรือ comma-separated?</h5>
                <p>A: แนะนำ JSON เพราะจัดการง่ายกว่า</p>

                <h5 class="mt-3">Q: Provider ไหนมี claim อะไรบ้าง?</h5>
                <p>A: ดูที่ <code>config/providers/{provider}.php</code></p>

                <div class="alert alert-warning mt-4">
                    <strong>⚠️ ข้อควรระวัง:</strong>
                    <ul class="mb-0">
                        <li>ตรวจสอบ NULL เสมอก่อนใช้ Extended Claims</li>
                        <li>Groups เป็น JSON string ต้อง decode ก่อนใช้</li>
                        <li>ทดสอบกับทั้ง PSU SSO และ Providers อื่นๆ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
