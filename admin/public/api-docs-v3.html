<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSO-Authen V.3 - Developer Documentation</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
      // Initialize Mermaid.js configuration
      if (typeof mermaid !== "undefined") {
        mermaid.initialize({
          startOnLoad: false,
          theme: "default",
          securityLevel: "loose",
          flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
          },
          sequence: {
            useMaxWidth: true,
            wrap: true,
            width: 150,
            height: 50,
            boxMargin: 10,
            boxTextMargin: 5,
            noteMargin: 10,
            messageMargin: 35,
            messageAlign: 'center',
            mirrorActors: true,
            bottomMarginAdj: 1,
            actorFontSize: 14,
            actorFontWeight: 400,
            messageFontSize: 13
          }
        });
      }
    </script>
    <style>
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
        z-index: 1000;
      }
      .main-content {
        margin-left: 280px;
        padding: 2rem;
        margin-bottom: 20px;
      }
      .nav-section {
        padding: 1rem 0;
        border-bottom: 1px solid #dee2e6;
      }
      .nav-section h6 {
        color: #6c757d;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }
      .nav-link {
        color: #495057;
        padding: 0.375rem 1rem;
        border-radius: 0.375rem;
        margin: 0.125rem 0;
        text-decoration: none;
        font-size: 0.875rem;
      }
      .nav-link:hover {
        background-color: #e9ecef;
        color: #495057;
      }
      .nav-link.active {
        background-color: #0d6efd;
        color: white;
      }
      .endpoint-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin: 1rem 0;
      }
      .endpoint-header {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .http-method {
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
      }
      .method-get {
        background: #d1ecf1;
        color: #0c5460;
      }
      .method-post {
        background: #d4edda;
        color: #155724;
      }
      .method-put {
        background: #fff3cd;
        color: #856404;
      }
      .method-delete {
        background: #f8d7da;
        color: #721c24;
      }
      .code-example {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin: 1rem 0;
      }
      .code-tabs {
        display: flex;
        border-bottom: 1px solid #dee2e6;
      }
      .code-tab {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
      }
      .code-tab.active {
        background: #e9ecef;
        border-bottom: 2px solid #0d6efd;
      }
      .code-content {
        padding: 1rem;
      }
      .code-block {
        display: none;
      }
      .code-block.active {
        display: block;
      }
      .response-example {
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        margin: 0.5rem 0;
      }
      .parameter-table th {
        background: #f8f9fa;
        font-weight: 600;
      }
      .badge-required {
        background: #dc3545;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
      }
      .badge-optional {
        background: #6c757d;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
      }
      .section-content {
        display: none;
      }
      .section-content.active {
        display: block;
      }
      .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin: -2rem -2rem 2rem -2rem;
      }
      .feature-card {
        transition: transform 0.2s;
      }
      .feature-card:hover {
        transform: translateY(-2px);
      }

      /* Mermaid diagram specific styles */
      .mermaid-container {
        overflow-x: auto;
        width: 100%;
      }
      
      .mermaid {
        font-size: 14px !important;
      }

      .mermaid .actor {
        stroke-width: 2px;
      }
      
      .mermaid .messageText {
        font-size: 13px !important;
        stroke: none !important;
      }
      
      /* Force actor boxes at both top and bottom with purple background */
      .mermaid rect.actor {
        fill: #ECECFF !important;
        stroke: #9370DB !important;
        stroke-width: 2px !important;
      }
      
      .mermaid .actor-box {
        fill: #ECECFF !important;
        stroke: #9370DB !important;
        stroke-width: 2px !important;
      }
      
      .mermaid line.actor-line {
        stroke: #999 !important;
        stroke-width: 0.5px !important;
      }
      
      .mermaid .actor-line {
        stroke: #999 !important;
        stroke-width: 0.5px !important;
      }

      .mermaid .messageText {
        font-size: 13px !important;
        stroke: none !important;
      }
      
      /* Fix actor text positioning */
      .mermaid .actor text {
        fill: #333 !important;
        font-weight: 400 !important;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s;
          width: 280px;
        }
        .sidebar.show {
          transform: translateX(0);
        }
        .main-content {
          margin-left: 0;
          padding: 1rem;
        }
        .hero-section {
          padding: 2rem 1rem;
          margin: -1rem -1rem 1rem -1rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mobile Menu Toggle -->
    <button
      class="btn btn-primary d-md-none position-fixed"
      style="top: 1rem; left: 1rem; z-index: 1100"
      onclick="toggleSidebar()"
    >
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
      <div class="p-3">
        <h5 class="mb-0">
          <i class="fas fa-shield-alt text-primary me-2"></i>
          SSO-Authen V.3
        </h5>
        <small class="text-muted">Developer Documentation</small>
      </div>

      <!-- Search Box -->
      <div class="px-3 py-2">
        <div class="input-group input-group-sm">
          <span class="input-group-text">
            <i class="fas fa-search"></i>
          </span>
          <input
            type="text"
            class="form-control"
            id="docsSearch"
            placeholder="Search documentation..."
            onkeyup="filterDocumentation()"
          />
        </div>
      </div>

      <div class="nav-section">
        <h6 class="px-3">Getting Started</h6>
        <a
          href="#overview"
          class="nav-link active"
          onclick="showSection('overview')"
        >
          <i class="fas fa-home me-2"></i>Overview
        </a>
        <a
          href="#architecture"
          class="nav-link"
          onclick="showSection('architecture')"
        >
          <i class="fas fa-sitemap me-2"></i>Architecture
        </a>
        <a
          href="#quickstart"
          class="nav-link"
          onclick="showSection('quickstart')"
        >
          <i class="fas fa-rocket me-2"></i>Quick Start
        </a>
      </div>

      <div class="nav-section">
        <h6 class="px-3">Client Integration</h6>
        <a
          href="#authentication-flow"
          class="nav-link"
          onclick="showSection('authentication-flow')"
        >
          <i class="fas fa-exchange-alt me-2"></i>Authentication Flow
        </a>
        <a
          href="#login-endpoint"
          class="nav-link"
          onclick="showSection('login-endpoint')"
        >
          <i class="fas fa-sign-in-alt me-2"></i>Login Endpoint
        </a>
        <a
          href="#callback-handling"
          class="nav-link"
          onclick="showSection('callback-handling')"
        >
          <i class="fas fa-reply me-2"></i>Callback Handling
        </a>
        <a
          href="#jwt-tokens"
          class="nav-link"
          onclick="showSection('jwt-tokens')"
        >
          <i class="fas fa-certificate me-2"></i>JWT Tokens
        </a>
        <a
          href="#user-handler-api"
          class="nav-link"
          onclick="showSection('user-handler-api')"
        >
          <i class="fas fa-user-cog me-2"></i>User Handler API
        </a>
        <a
          href="#logout-endpoint"
          class="nav-link"
          onclick="showSection('logout-endpoint')"
        >
          <i class="fas fa-sign-out-alt me-2"></i>Logout Endpoint
        </a>
      </div>

      <div class="nav-section">
        <h6 class="px-3">Admin Panel</h6>
        <a
          href="#admin-overview"
          class="nav-link"
          onclick="showSection('admin-overview')"
        >
          <i class="fas fa-user-shield me-2"></i>Overview
        </a>
        <a
          href="#client-management"
          class="nav-link"
          onclick="showSection('client-management')"
        >
          <i class="fas fa-users me-2"></i>Client Management
        </a>
        <!-- <a
          href="#dashboard-api"
          class="nav-link"
          onclick="showSection('dashboard-api')"
        >
          <i class="fas fa-chart-line me-2"></i>Dashboard API
        </a> -->
        <a
          href="#backup-restore"
          class="nav-link"
          onclick="showSection('backup-restore')"
        >
          <i class="fas fa-database me-2"></i>Backup & Restore
        </a>
      </div>

      <div class="nav-section">
        <h6 class="px-3">Code Examples</h6>
        <a
          href="#php-example"
          class="nav-link"
          onclick="showSection('php-example')"
        >
          <i class="fab fa-php me-2"></i>PHP Client
        </a>
        <a
          href="#javascript-example"
          class="nav-link"
          onclick="showSection('javascript-example')"
        >
          <i class="fab fa-js me-2"></i>JavaScript Client
        </a>
        <a
          href="#react-example"
          class="nav-link"
          onclick="showSection('react-example')"
        >
          <i class="fab fa-react me-2"></i>React Client
        </a>
      </div>

      <div class="nav-section">
        <h6 class="px-3">Resources</h6>
        <a
          href="#troubleshooting"
          class="nav-link"
          onclick="showSection('troubleshooting')"
        >
          <i class="fas fa-question-circle me-2"></i>Troubleshooting
        </a>
        <a href="#faq" class="nav-link" onclick="showSection('faq')">
          <i class="fas fa-lightbulb me-2"></i>FAQ
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Overview Section -->
      <div id="overview" class="section-content active">
        <div class="hero-section text-center">
          <div class="container">
            <h1 class="display-4 fw-bold">SSO-Authen V.3</h1>
            <p class="lead">Centralized OpenID Connect Gateway</p>
            <p class="mb-4">
              Deploy once, authenticate everywhere - A stateless SSO service for all your applications
            </p>
            <div class="d-flex justify-content-center gap-3">
              <button
                class="btn btn-light btn-lg"
                onclick="showSection('quickstart')"
              >
                <i class="fas fa-rocket me-2"></i>Get Started
              </button>
              <button
                class="btn btn-outline-light btn-lg"
                onclick="showSection('authentication-flow')"
              >
                <i class="fas fa-exchange-alt me-2"></i>See How It Works
              </button>
            </div>
          </div>
        </div>

        <div class="row mt-5">
          <div class="col-md-4">
            <div class="card feature-card h-100">
              <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                <h5>OIDC Gateway</h5>
                <p class="text-muted">
                  Acts as a bridge between your applications and OIDC providers (PSU SSO, Google, Microsoft, etc.)
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card feature-card h-100">
              <div class="card-body text-center">
                <i class="fas fa-code fa-3x text-success mb-3"></i>
                <h5>Technology Agnostic</h5>
                <p class="text-muted">
                  Works with any tech stack - PHP, Node.js, React, Vue, or any language that can handle HTTP redirects and JWT
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card feature-card h-100">
              <div class="card-body text-center">
                <i class="fas fa-certificate fa-3x text-info mb-3"></i>
                <h5>Stateless JWT</h5>
                <p class="text-muted">
                  Issues signed JWT tokens with user data, enabling modern stateless authentication architecture
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-12">
            <h3>What is SSO-Authen V.3?</h3>
            <p>
              SSO-Authen V.3 is a <strong>centralized authentication gateway</strong> that implements the OpenID Connect (OIDC) standard.
              Instead of each application implementing its own authentication with various providers, you deploy SSO-Authen once
              and all your applications authenticate through it.
            </p>

            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Key Concept:</strong> SSO-Authen is <strong>NOT an OIDC Provider</strong> itself. It's an <strong>OIDC Client/Gateway</strong>
              that connects to external providers (like PSU SSO, Google, Microsoft) and provides a unified authentication interface to your applications.
            </div>

            <h4 class="mt-4">Core Features</h4>
            <ul>
              <li><strong>Centralized Service:</strong> One deployment serves all applications</li>
              <li><strong>Multi-Client Support:</strong> Manage multiple applications from one admin panel</li>
              <li><strong>JWT-Based:</strong> Returns signed JWT tokens for stateless authentication</li>
              <li><strong>Legacy Mode:</strong> Supports traditional PHP session-based authentication for backward compatibility</li>
              <li><strong>Multi-Provider:</strong> Connect to any OIDC provider through flexible configuration</li>
              <li><strong>Data Normalization:</strong> Standardizes user claims across different providers</li>
              <li><strong>Decoupled Authorization:</strong> Separates authentication from application-specific authorization</li>
            </ul>

            <h4 class="mt-4">How It Works (Simple Version)</h4>
            <ol>
              <li>User clicks "Login" in your application â†’ redirects to SSO-Authen</li>
              <li>SSO-Authen handles authentication with the OIDC provider (e.g., PSU SSO)</li>
              <li>After successful authentication, SSO-Authen calls your app's API to create/update user in your database</li>
              <li>SSO-Authen generates a JWT token with user data and redirects back to your app</li>
              <li>Your app validates the JWT and creates its own session/state</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Architecture Section -->
      <div id="architecture" class="section-content">
        <h1>System Architecture</h1>
        <p class="lead">Understanding how SSO-Authen V.3 works</p>

        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Important:</strong> SSO-Authen is an <strong>OIDC Client</strong>, not an OIDC Provider.
          It connects to external providers and provides a unified gateway to your applications.
        </div>

        <h3>Complete Authentication Flow</h3>
        <p>
          This diagram shows the complete flow from user login to receiving JWT token:
        </p>

        <div class="card">
          <div class="card-body">
            <div class="mermaid-container">
              <pre class="mermaid" style="width: 100%; min-width: 1500px; margin: 0 auto;">
%%{init: {'theme':'default', 'sequence': {'mirrorActors':true, 'bottomMarginAdj':1}}}%%
sequenceDiagram
    autonumber
    actor User as User<br/>(Browser)
    actor ClientApp as Client App
    actor SsoAuthen as SSO-Authen
    actor OidcProvider as OIDC Provider<br/>(PSU SSO)

    User->>ClientApp: Access web app
    ClientApp->>User: Show Login button
    User->>SsoAuthen: Click Login
    SsoAuthen->>SsoAuthen: Verify client_id
    SsoAuthen->>User: Redirect to Provider
    User->>OidcProvider: Authenticate
    OidcProvider->>User: Return Auth Code
    User->>SsoAuthen: /callback.php
    SsoAuthen->>OidcProvider: Exchange Code for Token
    OidcProvider-->>SsoAuthen: Return ID Token
    SsoAuthen->>ClientApp: Call User Handler API
    ClientApp-->>SsoAuthen: Return user data
    SsoAuthen->>SsoAuthen: Generate JWT
    SsoAuthen->>User: Redirect with JWT
    User->>ClientApp: /callback
    ClientApp->>ClientApp: Verify JWT
    User->>ClientApp: Access app
              </pre>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Step-by-Step Explanation</h3>
        <div class="accordion" id="flowAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                Steps 1-3: Login Initiation
              </button>
            </h2>
            <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#flowAccordion">
              <div class="accordion-body">
                <p>User accesses your application and clicks the login link that points to:</p>
                <code>https://sso.oas.psu.ac.th/public/login.php?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_CALLBACK_URL</code>
                <p class="mt-2">SSO-Authen validates the client_id and redirect_uri against registered clients in the database.</p>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                Steps 4-7: OIDC Provider Authentication
              </button>
            </h2>
            <div id="step2" class="accordion-collapse collapse" data-bs-parent="#flowAccordion">
              <div class="accordion-body">
                <p>SSO-Authen stores client information in session and redirects user to the configured OIDC provider (e.g., PSU SSO).</p>
                <p>User authenticates with the provider and is redirected back to SSO-Authen's callback with an authorization code.</p>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                Steps 8-10: Token Exchange
              </button>
            </h2>
            <div id="step3" class="accordion-collapse collapse" data-bs-parent="#flowAccordion">
              <div class="accordion-body">
                <p>SSO-Authen exchanges the authorization code for an ID token through a back-channel call to the OIDC provider.</p>
                <p>This step happens server-to-server and includes user information from the provider.</p>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step4">
                Steps 11-12: User Handler API Call
              </button>
            </h2>
            <div id="step4" class="accordion-collapse collapse" data-bs-parent="#flowAccordion">
              <div class="accordion-body">
                <p><strong>This is unique to SSO-Authen V.3!</strong></p>
                <p>SSO-Authen makes a POST request to your application's <code>user_handler_endpoint</code> with:</p>
                <ul>
                  <li><strong>normalizedUser:</strong> Standardized user data from provider</li>
                  <li><strong>ssoUserInfo:</strong> Raw user data from provider</li>
                </ul>
                <p>Your application should:</p>
                <ol>
                  <li>Find or create the user in your database</li>
                  <li>Assign roles/permissions as needed</li>
                  <li>Return the user data with your internal ID and role</li>
                </ol>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step5">
                Steps 13-17: JWT Generation and Redirect
              </button>
            </h2>
            <div id="step5" class="accordion-collapse collapse" data-bs-parent="#flowAccordion">
              <div class="accordion-body">
                <p>SSO-Authen generates a signed JWT containing the user data from your application and redirects to your callback URL with the token.</p>
                <p>Your application validates the JWT signature and creates its own session/state management.</p>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Key Components</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-folder me-2"></i>SSO-Authen Endpoints</h5>
              </div>
              <div class="card-body">
                <ul class="list-unstyled">
                  <li><i class="fas fa-check text-success me-2"></i><code>/public/login.php</code> - Login initiation</li>
                  <li><i class="fas fa-check text-success me-2"></i><code>/public/callback.php</code> - OIDC callback handler</li>
                  <li><i class="fas fa-check text-success me-2"></i><code>/public/logout.php</code> - Logout endpoint</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h5><i class="fas fa-cog me-2"></i>Configuration</h5>
              </div>
              <div class="card-body">
                <p><strong>Clients are stored in database and managed via Admin Panel</strong></p>
                <p>Each client has:</p>
                <ul class="mb-0">
                  <li><code>client_id</code> - Unique identifier</li>
                  <li><code>app_redirect_uri</code> - Callback URL after authentication</li>
                  <li><code>post_logout_redirect_uri</code> - Redirect URL after logout</li>
                  <li><code>user_handler_endpoint</code> - Your API endpoint</li>
                  <li><code>api_secret_key</code> - For API authentication</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Start Section -->
      <div id="quickstart" class="section-content">
        <h1>Quick Start Guide</h1>
        <p class="lead">Integrate your application in 5 steps</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Prerequisites:</strong> You need a registered client_id and your app must have a callback endpoint and user handler API.
        </div>

        <h3>Step 1: Register Your Application</h3>
        <p>Contact your SSO administrator to register your application. You'll receive:</p>
        <ul>
          <li><code>client_id</code> - Your unique application identifier</li>
          <li><code>app_redirect_uri</code> - Your callback URL (must be registered)</li>
          <li><code>api_secret_key</code> - Secret for API authentication</li>
        </ul>

        <h3>Step 2: Create Login Link</h3>
        <p>Add a login button/link in your application that redirects to:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('login-html')">
              HTML
            </button>
            <button class="code-tab" onclick="showCodeTab('login-js')">
              JavaScript
            </button>
            <button class="code-tab" onclick="showCodeTab('login-php')">
              PHP
            </button>
          </div>
          <div class="code-content">
            <div id="login-html" class="code-block active">
              <pre><code class="language-html">&lt;!-- Simple HTML Link --&gt;
&lt;a href="https://sso.oas.psu.ac.th/public/login.php?client_id=YOUR_CLIENT_ID&redirect_uri=https://yourapp.com/callback" 
   class="btn btn-primary"&gt;
  Login with SSO
&lt;/a&gt;</code></pre>
            </div>
            <div id="login-js" class="code-block">
              <pre><code class="language-javascript">// JavaScript redirect
function loginWithSSO() {
  const params = new URLSearchParams({
    client_id: 'YOUR_CLIENT_ID',
    redirect_uri: window.location.origin + '/callback'
  });
  
  window.location.href = `https://sso.oas.psu.ac.th/public/login.php?${params}`;
}</code></pre>
            </div>
            <div id="login-php" class="code-block">
              <pre><code class="language-php">&lt;?php
// PHP redirect
$loginUrl = 'https://sso.oas.psu.ac.th/public/login.php?' . http_build_query([
    'client_id' => 'YOUR_CLIENT_ID',
    'redirect_uri' => 'https://yourapp.com/callback.php'
]);

header("Location: $loginUrl");
exit;
?&gt;</code></pre>
            </div>
          </div>
        </div>

        <h3>Step 3: Implement User Handler API</h3>
        <p>Create an API endpoint in your application that SSO-Authen will call to create/update users:</p>

        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Important:</strong> This endpoint must verify the X-API-SECRET header for security.
        </div>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('handler-php')">
              PHP
            </button>
            <button class="code-tab" onclick="showCodeTab('handler-node')">
              Node.js
            </button>
          </div>
          <div class="code-content">
            <div id="handler-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
// user-handler.php
header('Content-Type: application/json');

// 1. Verify API Secret
$receivedSecret = $_SERVER['HTTP_X_API_SECRET'] ?? '';
if ($receivedSecret !== 'YOUR_API_SECRET_KEY') {
    http_response_code(401);
    echo json_encode(['error' => 'Unauthorized']);
    exit;
}

// 2. Get user data from request
$input = json_decode(file_get_contents('php://input'), true);
$normalizedUser = $input['normalizedUser'];

// 3. Find or create user in database
$pdo = new PDO('mysql:host=localhost;dbname=yourdb', 'user', 'pass');
$stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
$stmt->execute([$normalizedUser['email']]);
$user = $stmt->fetch(PDO::FETCH_ASSOC);

if (!$user) {
    // Create new user
    $stmt = $pdo->prepare(
        "INSERT INTO users (email, name) VALUES (?, ?)"
    );
    $stmt->execute([$normalizedUser['email'], $normalizedUser['name']]);
    $user = [
        'id' => $pdo->lastInsertId(),
        'email' => $normalizedUser['email'],
        'name' => $normalizedUser['name'],
        'role' => 'user'
    ];
}

// 4. Return user data
echo json_encode($user);
?&gt;</code></pre>
            </div>
            <div id="handler-node" class="code-block">
              <pre><code class="language-javascript">// Express.js example
app.post('/api/sso-user-handler', async (req, res) => {
  // 1. Verify API Secret
  if (req.headers['x-api-secret'] !== process.env.API_SECRET) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  // 2. Get user data
  const { normalizedUser } = req.body;

  // 3. Find or create user
  let user = await User.findOne({ email: normalizedUser.email });
  if (!user) {
    user = await User.create({
      email: normalizedUser.email,
      name: normalizedUser.name,
      role: 'user'
    });
  }

  // 4. Return user data
  res.json({ id: user.id, email: user.email, name: user.name, role: user.role });
});</code></pre>
            </div>
          </div>
        </div>

        <h3>Step 4: Create Callback Handler</h3>
        <p>Handle the redirect from SSO-Authen with JWT token:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('callback-php')">
              PHP
            </button>
            <button class="code-tab" onclick="showCodeTab('callback-js')">
              JavaScript
            </button>
          </div>
          <div class="code-content">
            <div id="callback-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
// callback.php
require 'vendor/autoload.php';
use Firebase\JWT\JWT;
use Firebase\JWT\Key;

session_start();
$jwt = $_GET['token'] ?? null;

if (!$jwt) {
    die('No token received');
}

try {
    $decoded = JWT::decode($jwt, new Key('JWT_SECRET_KEY', 'HS256'));
    $_SESSION['logged_in'] = true;
    $_SESSION['user'] = (array) $decoded->data;
    header('Location: /dashboard.php');
} catch (Exception $e) {
    die('Invalid token');
}
?&gt;</code></pre>
            </div>
            <div id="callback-js" class="code-block">
              <pre><code class="language-javascript">// Get token from URL
const token = new URLSearchParams(window.location.search).get('token');

if (token) {
  localStorage.setItem('jwt_token', token);
  window.location.href = '/dashboard';
}</code></pre>
            </div>
          </div>
        </div>

        <div class="alert alert-success mt-4">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Done!</strong> Your application is now integrated with SSO-Authen V.3.
        </div>
      </div>

      <!-- Authentication Flow Details Section -->
      <div id="authentication-flow" class="section-content">
        <h1>Authentication Flow Details</h1>
        <p class="lead">Complete guide to the authentication process</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Prerequisites:</strong> Before integrating, ensure you have a registered client_id and understand the basic flow from the Architecture section.
        </div>

        <h3>Authentication Modes</h3>
        <p>SSO-Authen V.3 supports two authentication modes based on your application's architecture:</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-certificate me-2"></i>JWT Mode (Recommended)</h5>
              </div>
              <div class="card-body">
                <p><strong>For modern applications</strong></p>
                <p>SSO-Authen generates a signed JWT token and redirects back to your application. Your app validates the JWT and manages its own session.</p>
                
                <h6 class="mt-3">When to use:</h6>
                <ul>
                  <li>React, Vue, Angular applications</li>
                  <li>Node.js, Python, Java backends</li>
                  <li>API-first architectures</li>
                  <li>Microservices</li>
                  <li>Mobile applications</li>
                </ul>

                <h6 class="mt-3">Requirements:</h6>
                <ul>
                  <li>Implement <code>user_handler_endpoint</code> API</li>
                  <li>JWT validation library</li>
                  <li>Ability to manage sessions/state</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-server me-2"></i>Legacy Mode</h5>
              </div>
              <div class="card-body">
                <p><strong>For traditional PHP applications</strong></p>
                <p>SSO-Authen creates a PHP session directly and redirects back to your application on the same domain.</p>
                
                <h6 class="mt-3">When to use:</h6>
                <ul>
                  <li>Legacy PHP applications</li>
                  <li>Applications on same domain as SSO-Authen</li>
                  <li>Backward compatibility requirements</li>
                </ul>

                <h6 class="mt-3">Requirements:</h6>
                <ul>
                  <li>Must be on same domain as SSO-Authen</li>
                  <li>Set <code>user_handler_endpoint</code> to null</li>
                  <li>Implement <code>findOrCreateUser()</code> function</li>
                </ul>

                <div class="alert alert-warning mt-3 mb-0">
                  <small><strong>Note:</strong> Legacy Mode is for backward compatibility only. New applications should use JWT Mode.</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Detailed Flow Breakdown</h3>
        
        <h4>Phase 1: Login Initiation</h4>
        <p>When a user clicks login in your application:</p>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// Redirect to SSO login endpoint
const loginUrl = `https://sso.oas.psu.ac.th/public/login.php?` +
  `client_id=YOUR_CLIENT_ID&` +
  `redirect_uri=${encodeURIComponent('https://yourapp.com/callback')}`;

window.location.href = loginUrl;</code></pre>
          </div>
        </div>

        <p>SSO-Authen will:</p>
        <ol>
          <li>Validate the <code>client_id</code> exists in database</li>
          <li>Verify <code>redirect_uri</code> matches registered URI</li>
          <li>Store client information in session</li>
          <li>Redirect user to configured OIDC provider</li>
        </ol>

        <h4 class="mt-3">Phase 2: Provider Authentication</h4>
        <p>The OIDC provider (e.g., PSU SSO) handles user authentication:</p>
        <ul>
          <li>User enters credentials on provider's login page</li>
          <li>Provider validates credentials</li>
          <li>Provider generates authorization code</li>
          <li>Provider redirects back to SSO-Authen's callback URL</li>
        </ul>

        <h4 class="mt-3">Phase 3: Token Exchange & User Handler</h4>
        <p>SSO-Authen processes the callback:</p>
        <ol>
          <li>Exchanges authorization code for ID token (back-channel to provider)</li>
          <li>Extracts and normalizes user data from ID token</li>
          <li><strong>Calls your app's User Handler API</strong> with normalized data</li>
          <li>Receives user data with internal ID and role from your app</li>
        </ol>

        <div class="alert alert-success">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Key Insight:</strong> This is what makes SSO-Authen unique! It delegates user creation and role assignment to YOUR application, keeping authentication and authorization separate.
        </div>

        <h4 class="mt-3">Phase 4: JWT Generation & Redirect</h4>
        <p>SSO-Authen completes the process:</p>
        <ol>
          <li>Creates a signed JWT containing user data from your app</li>
          <li>Redirects to your <code>redirect_uri</code> with token as query parameter</li>
        </ol>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">https://yourapp.com/callback?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</code></pre>
          </div>
        </div>

        <h4 class="mt-3">Phase 5: Your App's Callback</h4>
        <p>Your application receives and processes the JWT:</p>
        <ol>
          <li>Extracts token from URL query parameter</li>
          <li>Validates JWT signature using shared secret</li>
          <li>Checks token expiration</li>
          <li>Creates application-specific session/state</li>
          <li>Redirects user to dashboard or requested page</li>
        </ol>
      </div>

      <div id="login-endpoint" class="section-content">
        <h1>Login Endpoint</h1>
        <p class="lead">Initiating authentication - /public/login.php</p>

        <div class="endpoint-card">
          <div class="endpoint-header">
            <div>
              <span class="http-method method-get">GET</span>
              <strong>/public/login.php</strong>
            </div>
            <span class="badge bg-primary">Public Endpoint</span>
          </div>
          <div class="card-body">
            <h5>Description</h5>
            <p>This endpoint initiates the OIDC authentication flow. Users are redirected here from your application to begin the login process.</p>

            <h5>Query Parameters</h5>
            <table class="table table-bordered parameter-table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Type</th>
                  <th>Required</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>client_id</code></td>
                  <td>string</td>
                  <td><span class="badge-required">Required</span></td>
                  <td>Your registered client application ID</td>
                </tr>
                <tr>
                  <td><code>redirect_uri</code></td>
                  <td>string</td>
                  <td><span class="badge-required">Required</span></td>
                  <td>The callback URL where user will be redirected after authentication. Must exactly match the registered URI.</td>
                </tr>
              </tbody>
            </table>

            <h5>Example Request</h5>
            <div class="code-example">
              <div class="code-tabs">
                <button class="code-tab active" onclick="showCodeTab('login-url')">
                  URL
                </button>
                <button class="code-tab" onclick="showCodeTab('login-js-ex')">
                  JavaScript
                </button>
                <button class="code-tab" onclick="showCodeTab('login-php-ex')">
                  PHP
                </button>
              </div>
              <div class="code-content">
                <div id="login-url" class="code-block active">
                  <pre><code class="language-text">GET https://sso.oas.psu.ac.th/public/login.php?client_id=my_app_123&redirect_uri=https%3A%2F%2Fmyapp.com%2Fcallback</code></pre>
                </div>
                <div id="login-js-ex" class="code-block">
                  <pre><code class="language-javascript">function loginWithSSO() {
  const params = new URLSearchParams({
    client_id: 'my_app_123',
    redirect_uri: 'https://myapp.com/callback'
  });
  
  window.location.href = `https://sso.oas.psu.ac.th/public/login.php?${params}`;
}</code></pre>
                </div>
                <div id="login-php-ex" class="code-block">
                  <pre><code class="language-php">&lt;?php
$loginUrl = 'https://sso.oas.psu.ac.th/public/login.php?' . http_build_query([
    'client_id' => 'my_app_123',
    'redirect_uri' => 'https://myapp.com/callback.php'
]);

header("Location: $loginUrl");
exit;
?&gt;</code></pre>
                </div>
              </div>
            </div>

            <h5>Response</h5>
            <p>This endpoint does not return JSON. Instead, it:</p>
            <ol>
              <li>Validates the <code>client_id</code> and <code>redirect_uri</code></li>
              <li>Stores client information in PHP session</li>
              <li>Redirects (HTTP 302) the user to the configured OIDC provider's login page</li>
            </ol>

            <h5>Error Responses</h5>
            <p>If validation fails, an error message is displayed using SweetAlert2:</p>
            
            <div class="row">
              <div class="col-md-6">
                <div class="response-example">
                  <h6>Missing Parameters</h6>
                  <pre><code class="language-json">{
  "title": "Configuration Error",
  "message": "client_id and redirect_uri are required",
  "icon": "error"
}</code></pre>
                </div>
              </div>
              <div class="col-md-6">
                <div class="response-example">
                  <h6>Unauthorized Client</h6>
                  <pre><code class="language-json">{
  "title": "Configuration Error",
  "message": "Unauthorized client ID: xxx",
  "icon": "error"
}</code></pre>
                </div>
              </div>
              <div class="col-md-6">
                <div class="response-example">
                  <h6>Invalid Redirect URI</h6>
                  <pre><code class="language-json">{
  "title": "Configuration Error",
  "message": "Redirect URI does not match registered URI",
  "icon": "error"
}</code></pre>
                </div>
              </div>
            </div>

            <h5 class="mt-3">Security Notes</h5>
            <div class="alert alert-warning">
              <ul class="mb-0">
                <li><strong>URI Validation:</strong> The redirect_uri must exactly match the registered URI (including protocol, domain, port, and path)</li>
                <li><strong>Client Registration:</strong> Only registered clients in the database can use this endpoint</li>
                <li><strong>No Client Secret:</strong> This endpoint does not require client_secret (PKCE flow)</li>
                <li><strong>Session Security:</strong> Client data is stored in secure PHP session with httpOnly cookies</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div id="callback-handling" class="section-content">
        <h1>Callback Handling</h1>
        <p class="lead">Processing authentication response in your application</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Overview:</strong> After successful authentication, SSO-Authen redirects the user back to your <code>redirect_uri</code> with a JWT token. Your application must validate this token and create a session.
        </div>

        <h3>Callback URL Format</h3>
        <p>The user will be redirected to your callback URL with the JWT token as a query parameter:</p>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">https://yourapp.com/callback?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjo...</code></pre>
          </div>
        </div>

        <h3>Step 1: Extract Token from URL</h3>
        <p>First, extract the token from the query parameters:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('extract-js')">
              JavaScript
            </button>
            <button class="code-tab" onclick="showCodeTab('extract-php')">
              PHP
            </button>
          </div>
          <div class="code-content">
            <div id="extract-js" class="code-block active">
              <pre><code class="language-javascript">// Modern JavaScript (React, Vue, etc.)
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
  console.error('No token received');
  window.location.href = '/login';
}</code></pre>
            </div>
            <div id="extract-php" class="code-block">
              <pre><code class="language-php">&lt;?php
// PHP application
$token = $_GET['token'] ?? null;

if (!$token) {
    die('No token received');
}
?&gt;</code></pre>
            </div>
          </div>
        </div>

        <h3>Step 2: Validate JWT Token</h3>
        <p>Validate the token signature and expiration using a JWT library:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('validate-php')">
              PHP (Firebase JWT)
            </button>
            <button class="code-tab" onclick="showCodeTab('validate-node')">
              Node.js (jsonwebtoken)
            </button>
            <button class="code-tab" onclick="showCodeTab('validate-python')">
              Python (PyJWT)
            </button>
          </div>
          <div class="code-content">
            <div id="validate-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
require 'vendor/autoload.php';
use Firebase\JWT\JWT;
use Firebase\JWT\Key;

$jwtSecret = 'your_jwt_secret_key'; // Same as configured in SSO-Authen

try {
    // Decode and validate token
    $decoded = JWT::decode($token, new Key($jwtSecret, 'HS256'));
    
    // Token is valid, extract user data
    $userData = (array) $decoded->data;
    
    echo "User authenticated: " . $userData['email'];
    
} catch (\Firebase\JWT\ExpiredException $e) {
    die('Token has expired');
} catch (\Firebase\JWT\SignatureInvalidException $e) {
    die('Invalid token signature');
} catch (Exception $e) {
    die('Token validation failed: ' . $e->getMessage());
}
?&gt;</code></pre>
            </div>
            <div id="validate-node" class="code-block">
              <pre><code class="language-javascript">const jwt = require('jsonwebtoken');

const jwtSecret = process.env.JWT_SECRET; // Same as configured in SSO-Authen

try {
  // Decode and validate token
  const decoded = jwt.verify(token, jwtSecret);
  
  // Token is valid, extract user data
  const userData = decoded.data;
  
  console.log('User authenticated:', userData.email);
  
} catch (err) {
  if (err.name === 'TokenExpiredError') {
    console.error('Token has expired');
  } else if (err.name === 'JsonWebTokenError') {
    console.error('Invalid token');
  } else {
    console.error('Token validation failed:', err.message);
  }
}</code></pre>
            </div>
            <div id="validate-python" class="code-block">
              <pre><code class="language-python">import jwt
import os

jwt_secret = os.getenv('JWT_SECRET')  # Same as configured in SSO-Authen

try:
    # Decode and validate token
    decoded = jwt.decode(token, jwt_secret, algorithms=['HS256'])
    
    # Token is valid, extract user data
    user_data = decoded['data']
    
    print(f"User authenticated: {user_data['email']}")
    
except jwt.ExpiredSignatureError:
    print('Token has expired')
except jwt.InvalidTokenError:
    print('Invalid token')
except Exception as e:
    print(f'Token validation failed: {str(e)}')</code></pre>
            </div>
          </div>
        </div>

        <div class="alert alert-danger mt-3">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Critical:</strong> Always validate the JWT signature! Never trust the token content without verification. The <code>JWT_SECRET</code> must match exactly with the one configured in SSO-Authen.
        </div>

        <h3>Step 3: Extract User Data</h3>
        <p>After successful validation, the decoded token contains user information in the <code>data</code> property:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('extract-data-php')">
              PHP
            </button>
            <button class="code-tab" onclick="showCodeTab('extract-data-js')">
              JavaScript
            </button>
          </div>
          <div class="code-content">
            <div id="extract-data-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
// After successful JWT validation
$userData = (array) $decoded->data;

// Available fields (from your User Handler API response)
$userId = $userData['id'];           // Your internal user ID
$userEmail = $userData['email'];     // User's email
$userName = $userData['name'];       // User's display name
$userRole = $userData['role'];       // User's role in your system

// Any additional fields you returned from User Handler
if (isset($userData['department'])) {
    $department = $userData['department'];
}
?&gt;</code></pre>
            </div>
            <div id="extract-data-js" class="code-block">
              <pre><code class="language-javascript">// After successful JWT validation
const userData = decoded.data;

// Available fields (from your User Handler API response)
const userId = userData.id;        // Your internal user ID
const userEmail = userData.email;  // User's email
const userName = userData.name;    // User's display name
const userRole = userData.role;    // User's role in your system

// Any additional fields you returned from User Handler
if (userData.department) {
  const department = userData.department;
}</code></pre>
            </div>
          </div>
        </div>

        <h3>Step 4: Create Application Session</h3>
        <p>Store the user information in your application's session or state management:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('session-php')">
              PHP Session
            </button>
            <button class="code-tab" onclick="showCodeTab('session-express')">
              Express.js
            </button>
            <button class="code-tab" onclick="showCodeTab('session-react')">
              React Context
            </button>
          </div>
          <div class="code-content">
            <div id="session-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
session_start();

// Store user data in session
$_SESSION['logged_in'] = true;
$_SESSION['user'] = [
    'id' => $userData['id'],
    'email' => $userData['email'],
    'name' => $userData['name'],
    'role' => $userData['role']
];

// Store token for API calls
$_SESSION['jwt_token'] = $token;

// Redirect to dashboard
header('Location: /dashboard.php');
exit;
?&gt;</code></pre>
            </div>
            <div id="session-express" class="code-block">
              <pre><code class="language-javascript">// Express.js with express-session
app.get('/callback', (req, res) => {
  const token = req.query.token;
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // Store in session
    req.session.loggedIn = true;
    req.session.user = decoded.data;
    req.session.jwtToken = token;
    
    res.redirect('/dashboard');
  } catch (err) {
    res.status(401).send('Authentication failed');
  }
});</code></pre>
            </div>
            <div id="session-react" class="code-block">
              <pre><code class="language-javascript">// React - Store in localStorage and Context
import { useNavigate } from 'react-router-dom';
import { useAuth } from './AuthContext';

function CallbackPage() {
  const navigate = useNavigate();
  const { login } = useAuth();
  
  useEffect(() => {
    const token = new URLSearchParams(window.location.search).get('token');
    
    if (token) {
      // Validate token (you can use jwt-decode for decoding)
      // In production, validate on backend
      const decoded = jwtDecode(token);
      
      // Store token
      localStorage.setItem('jwt_token', token);
      localStorage.setItem('user', JSON.stringify(decoded.data));
      
      // Update auth context
      login(decoded.data, token);
      
      // Redirect to dashboard
      navigate('/dashboard');
    }
  }, []);
  
  return <div>Processing authentication...</div>;
}</code></pre>
            </div>
          </div>
        </div>

        <h3>Complete Callback Example</h3>
        <p>Here's a complete, production-ready callback handler:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('complete-php')">
              PHP
            </button>
            <button class="code-tab" onclick="showCodeTab('complete-node')">
              Node.js
            </button>
          </div>
          <div class="code-content">
            <div id="complete-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
// callback.php - Complete production-ready example
require 'vendor/autoload.php';
use Firebase\JWT\JWT;
use Firebase\JWT\Key;

session_start();

// Configuration
$jwtSecret = getenv('JWT_SECRET'); // Load from environment
$dashboardUrl = '/dashboard.php';
$loginUrl = '/login.php';

try {
    // 1. Extract token
    $token = $_GET['token'] ?? null;
    if (!$token) {
        throw new Exception('No authentication token received');
    }
    
    // 2. Validate JWT
    $decoded = JWT::decode($token, new Key($jwtSecret, 'HS256'));
    $userData = (array) $decoded->data;
    
    // 3. Additional validation (optional)
    if (empty($userData['id']) || empty($userData['email'])) {
        throw new Exception('Invalid user data in token');
    }
    
    // 4. Create session
    session_regenerate_id(true); // Prevent session fixation
    $_SESSION['logged_in'] = true;
    $_SESSION['user'] = $userData;
    $_SESSION['jwt_token'] = $token;
    $_SESSION['login_time'] = time();
    
    // 5. Log successful login (optional)
    error_log("User logged in: {$userData['email']} (ID: {$userData['id']})");
    
    // 6. Redirect to dashboard
    header("Location: $dashboardUrl");
    exit;
    
} catch (\Firebase\JWT\ExpiredException $e) {
    // Token expired
    $_SESSION['error'] = 'Your session has expired. Please login again.';
    header("Location: $loginUrl");
    exit;
    
} catch (\Firebase\JWT\SignatureInvalidException $e) {
    // Invalid signature - possible security issue
    error_log('JWT signature validation failed: ' . $e->getMessage());
    $_SESSION['error'] = 'Authentication failed. Please try again.';
    header("Location: $loginUrl");
    exit;
    
} catch (Exception $e) {
    // Other errors
    error_log('Callback error: ' . $e->getMessage());
    $_SESSION['error'] = 'Authentication error: ' . $e->getMessage();
    header("Location: $loginUrl");
    exit;
}
?&gt;</code></pre>
            </div>
            <div id="complete-node" class="code-block">
              <pre><code class="language-javascript">// callback.js - Complete production-ready example (Express.js)
const express = require('express');
const jwt = require('jsonwebtoken');
const router = express.Router();

router.get('/callback', async (req, res) => {
  try {
    // 1. Extract token
    const token = req.query.token;
    if (!token) {
      throw new Error('No authentication token received');
    }
    
    // 2. Validate JWT
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const userData = decoded.data;
    
    // 3. Additional validation (optional)
    if (!userData.id || !userData.email) {
      throw new Error('Invalid user data in token');
    }
    
    // 4. Create session
    req.session.regenerate((err) => {
      if (err) throw err;
      
      req.session.loggedIn = true;
      req.session.user = userData;
      req.session.jwtToken = token;
      req.session.loginTime = Date.now();
      
      // 5. Log successful login (optional)
      console.log(`User logged in: ${userData.email} (ID: ${userData.id})`);
      
      // 6. Redirect to dashboard
      res.redirect('/dashboard');
    });
    
  } catch (err) {
    console.error('Callback error:', err.message);
    
    if (err.name === 'TokenExpiredError') {
      req.session.error = 'Your session has expired. Please login again.';
    } else if (err.name === 'JsonWebTokenError') {
      req.session.error = 'Authentication failed. Please try again.';
    } else {
      req.session.error = `Authentication error: ${err.message}`;
    }
    
    res.redirect('/login');
  }
});

module.exports = router;</code></pre>
            </div>
          </div>
        </div>

        <h3>Security Best Practices</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>DO</h5>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Always validate JWT signature</li>
                  <li>Check token expiration</li>
                  <li>Use HTTPS for all communication</li>
                  <li>Store JWT_SECRET in environment variables</li>
                  <li>Regenerate session ID after login</li>
                  <li>Set httpOnly cookies for sessions</li>
                  <li>Implement rate limiting</li>
                  <li>Log authentication events</li>
                  <li>Handle errors gracefully</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-times-circle me-2"></i>DON'T</h5>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Never trust token without validation</li>
                  <li>Don't hardcode JWT_SECRET in code</li>
                  <li>Don't expose secret in client-side code</li>
                  <li>Don't store sensitive data in JWT</li>
                  <li>Don't ignore token expiration</li>
                  <li>Don't use HTTP (use HTTPS only)</li>
                  <li>Don't log sensitive information</li>
                  <li>Don't reuse session IDs</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-success mt-4">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Pro Tip:</strong> For React/Vue/Angular applications, consider validating the JWT on your backend API instead of the frontend, then create a secure httpOnly cookie for subsequent requests.
        </div>
      </div>

      <div id="jwt-tokens" class="section-content">
        <h1>JWT Tokens</h1>
        <p class="lead">Understanding JWT structure, claims, and validation</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>What is JWT?</strong> JSON Web Token (JWT) is an open standard (RFC 7519) for securely transmitting information between parties as a JSON object. SSO-Authen uses JWT to encode user information after successful authentication.
        </div>

        <h3>JWT Structure</h3>
        <p>A JWT consists of three parts separated by dots (.): <strong>Header.Payload.Signature</strong></p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoxMjMsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsIm5hbWUiOiJKb2huIERvZSIsInJvbGUiOiJ1c2VyIn0sImlhdCI6MTcwMDAwMDAwMCwiZXhwIjoxNzAwMDA3MjAwfQ.3YwVXz9xKlP2J5kGJnE8M6qR4WfT1cN7LbS9UeHgZqI

<span style="color: #fb015b;">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Header</span>
<span style="color: #d63aff;">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Payload</span>
<span style="color: #00b9f1;">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Signature</span></code></pre>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header" style="background-color: #fb015b; color: white;">
                <h5 class="mb-0">Header</h5>
              </div>
              <div class="card-body">
                <p>Contains metadata about the token:</p>
                <pre><code class="language-json">{
  "alg": "HS256",
  "typ": "JWT"
}</code></pre>
                <ul class="small mb-0">
                  <li><code>alg</code>: Signing algorithm (HMAC SHA256)</li>
                  <li><code>typ</code>: Token type (JWT)</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header" style="background-color: #d63aff; color: white;">
                <h5 class="mb-0">Payload</h5>
              </div>
              <div class="card-body">
                <p>Contains the claims (user data):</p>
                <pre><code class="language-json">{
  "data": {
    "id": 123,
    "email": "user@example.com",
    "name": "John Doe",
    "role": "user"
  },
  "iat": 1700000000,
  "exp": 1700007200
}</code></pre>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header" style="background-color: #00b9f1; color: white;">
                <h5 class="mb-0">Signature</h5>
              </div>
              <div class="card-body">
                <p>Verifies the token hasn't been tampered with:</p>
                <pre><code class="language-javascript">HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  JWT_SECRET_KEY
)</code></pre>
                <p class="small mb-0">Only someone with the secret key can create valid signatures.</p>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Token Claims</h3>
        <p>SSO-Authen generates JWT tokens with the following structure:</p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-json">{
  "data": {
    "id": 123,                    // Your internal user ID (from User Handler)
    "email": "user@psu.ac.th",   // User's email
    "name": "à¸™à¸²à¸¢à¸ªà¸¡à¸Šà¸²à¸¢ à¹ƒà¸ˆà¸”à¸µ",      // User's display name
    "role": "user",              // User's role (from User Handler)
    "department": "IT"           // Additional fields from User Handler
  },
  "iat": 1700000000,             // Issued At (timestamp)
  "exp": 1700007200              // Expiration Time (timestamp)
}</code></pre>
          </div>
        </div>

        <h4>Standard Claims</h4>
        <table class="table table-bordered parameter-table">
          <thead>
            <tr>
              <th>Claim</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>iat</code></td>
              <td>number</td>
              <td><strong>Issued At:</strong> Timestamp when token was created (Unix timestamp)</td>
            </tr>
            <tr>
              <td><code>exp</code></td>
              <td>number</td>
              <td><strong>Expiration Time:</strong> Timestamp when token expires (Unix timestamp). Default: 2 hours from issue time</td>
            </tr>
          </tbody>
        </table>

        <h4>Custom Claims (data object)</h4>
        <p>The <code>data</code> object contains user information returned from your User Handler API:</p>
        <table class="table table-bordered parameter-table">
          <thead>
            <tr>
              <th>Field</th>
              <th>Type</th>
              <th>Required</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>id</code></td>
              <td>string/number</td>
              <td><span class="badge-required">Required</span></td>
              <td>Your application's internal user ID</td>
            </tr>
            <tr>
              <td><code>email</code></td>
              <td>string</td>
              <td><span class="badge-required">Required</span></td>
              <td>User's email address</td>
            </tr>
            <tr>
              <td><code>name</code></td>
              <td>string</td>
              <td><span class="badge-required">Required</span></td>
              <td>User's display name</td>
            </tr>
            <tr>
              <td><code>role</code></td>
              <td>string</td>
              <td><span class="badge-optional">Optional</span></td>
              <td>User's role in your application (e.g., "admin", "user", "editor")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-muted"><em>...any additional fields returned by your User Handler API</em></td>
            </tr>
          </tbody>
        </table>

        <div class="alert alert-success">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Flexibility:</strong> You can include any additional fields in the <code>data</code> object by returning them from your User Handler API. SSO-Authen will include all fields in the JWT.
        </div>

        <h3>Token Expiration</h3>
        <p>JWT tokens have a configurable expiration time to balance security and user convenience:</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">Default Configuration</h5>
              </div>
              <div class="card-body">
                <table class="table table-sm mb-0">
                  <tr>
                    <td><strong>Expiration Time:</strong></td>
                    <td>2 hours (7200 seconds)</td>
                  </tr>
                  <tr>
                    <td><strong>Configuration:</strong></td>
                    <td><code>JWT_EXPIRATION</code> in config.php</td>
                  </tr>
                  <tr>
                    <td><strong>Calculation:</strong></td>
                    <td><code>exp = iat + JWT_EXPIRATION</code></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Expired Token Handling</h5>
              </div>
              <div class="card-body">
                <p>When a token expires:</p>
                <ol class="mb-0">
                  <li>JWT validation will throw <code>TokenExpiredError</code></li>
                  <li>User must re-authenticate</li>
                  <li>Redirect to login endpoint</li>
                  <li>User may have active SSO session (auto-login)</li>
                </ol>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">JWT Validation</h3>
        <p>Always validate JWT tokens before trusting their contents. Validation checks:</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Validation Steps</h5>
              </div>
              <div class="card-body">
                <ol>
                  <li><strong>Signature Verification</strong>
                    <ul><li>Verify token was signed with correct secret</li></ul>
                  </li>
                  <li><strong>Expiration Check</strong>
                    <ul><li>Ensure token hasn't expired (exp > current time)</li></ul>
                  </li>
                  <li><strong>Format Validation</strong>
                    <ul><li>Verify token has valid JWT structure</li></ul>
                  </li>
                  <li><strong>Claims Validation</strong>
                    <ul><li>Check required fields exist (id, email, name)</li></ul>
                  </li>
                </ol>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">Validation Libraries</h5>
              </div>
              <div class="card-body">
                <table class="table table-sm mb-0">
                  <tr>
                    <td><strong>PHP:</strong></td>
                    <td><code>firebase/php-jwt</code></td>
                  </tr>
                  <tr>
                    <td><strong>Node.js:</strong></td>
                    <td><code>jsonwebtoken</code></td>
                  </tr>
                  <tr>
                    <td><strong>Python:</strong></td>
                    <td><code>PyJWT</code></td>
                  </tr>
                  <tr>
                    <td><strong>Java:</strong></td>
                    <td><code>java-jwt</code></td>
                  </tr>
                  <tr>
                    <td><strong>.NET:</strong></td>
                    <td><code>System.IdentityModel.Tokens.Jwt</code></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Validation Examples</h3>
        
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('jwt-val-php')">
              PHP
            </button>
            <button class="code-tab" onclick="showCodeTab('jwt-val-node')">
              Node.js
            </button>
            <button class="code-tab" onclick="showCodeTab('jwt-val-python')">
              Python
            </button>
          </div>
          <div class="code-content">
            <div id="jwt-val-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
require 'vendor/autoload.php';
use Firebase\JWT\JWT;
use Firebase\JWT\Key;

function validateJWT($token) {
    $jwtSecret = getenv('JWT_SECRET');
    
    try {
        // Decode and validate
        $decoded = JWT::decode($token, new Key($jwtSecret, 'HS256'));
        
        // Verify required fields
        if (!isset($decoded->data->id) || !isset($decoded->data->email)) {
            throw new Exception('Missing required claims');
        }
        
        return [
            'valid' => true,
            'data' => $decoded->data
        ];
        
    } catch (\Firebase\JWT\ExpiredException $e) {
        return ['valid' => false, 'error' => 'Token expired'];
    } catch (\Firebase\JWT\SignatureInvalidException $e) {
        return ['valid' => false, 'error' => 'Invalid signature'];
    } catch (Exception $e) {
        return ['valid' => false, 'error' => $e->getMessage()];
    }
}

// Usage
$result = validateJWT($token);
if ($result['valid']) {
    echo "User: " . $result['data']->name;
} else {
    echo "Error: " . $result['error'];
}
?&gt;</code></pre>
            </div>
            <div id="jwt-val-node" class="code-block">
              <pre><code class="language-javascript">const jwt = require('jsonwebtoken');

function validateJWT(token) {
  try {
    // Decode and validate
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // Verify required fields
    if (!decoded.data.id || !decoded.data.email) {
      throw new Error('Missing required claims');
    }
    
    return {
      valid: true,
      data: decoded.data
    };
    
  } catch (err) {
    if (err.name === 'TokenExpiredError') {
      return { valid: false, error: 'Token expired' };
    } else if (err.name === 'JsonWebTokenError') {
      return { valid: false, error: 'Invalid signature' };
    } else {
      return { valid: false, error: err.message };
    }
  }
}

// Usage
const result = validateJWT(token);
if (result.valid) {
  console.log('User:', result.data.name);
} else {
  console.log('Error:', result.error);
}</code></pre>
            </div>
            <div id="jwt-val-python" class="code-block">
              <pre><code class="language-python">import jwt
import os

def validate_jwt(token):
    try:
        # Decode and validate
        decoded = jwt.decode(token, os.getenv('JWT_SECRET'), algorithms=['HS256'])
        
        # Verify required fields
        if 'id' not in decoded['data'] or 'email' not in decoded['data']:
            raise Exception('Missing required claims')
        
        return {
            'valid': True,
            'data': decoded['data']
        }
        
    except jwt.ExpiredSignatureError:
        return {'valid': False, 'error': 'Token expired'}
    except jwt.InvalidTokenError:
        return {'valid': False, 'error': 'Invalid signature'}
    except Exception as e:
        return {'valid': False, 'error': str(e)}

# Usage
result = validate_jwt(token)
if result['valid']:
    print(f"User: {result['data']['name']}")
else:
    print(f"Error: {result['error']}")</code></pre>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Decoding vs Validating</h3>
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Important Security Note:</strong> There's a critical difference between decoding and validating:
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-times-circle me-2"></i>Decode Only (INSECURE)</h5>
              </div>
              <div class="card-body">
                <pre><code class="language-javascript">// âŒ NEVER DO THIS - No verification!
const decoded = jwtDecode(token);
const userId = decoded.data.id;

// Attacker can forge tokens!</code></pre>
                <p class="mb-0 small text-danger"><strong>Risk:</strong> Anyone can create fake tokens with any user data. Never trust decoded data without verification!</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Validate (SECURE)</h5>
              </div>
              <div class="card-body">
                <pre><code class="language-javascript">// âœ… ALWAYS DO THIS - Verifies signature!
const decoded = jwt.verify(token, JWT_SECRET);
const userId = decoded.data.id;

// Only valid tokens work!</code></pre>
                <p class="mb-0 small text-success"><strong>Safe:</strong> Only tokens signed with the correct secret will be accepted. Forgery impossible without the secret.</p>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Token Security Best Practices</h3>
        <div class="row">
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Storage</h6>
              </div>
              <div class="card-body">
                <ul class="small mb-0">
                  <li>Use httpOnly cookies (server-side)</li>
                  <li>Avoid localStorage for sensitive apps</li>
                  <li>Consider sessionStorage as alternative</li>
                  <li>Never expose tokens in URLs</li>
                  <li>Clear tokens on logout</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">Transmission</h6>
              </div>
              <div class="card-body">
                <ul class="small mb-0">
                  <li>Always use HTTPS</li>
                  <li>Don't send tokens in GET parameters</li>
                  <li>Use Authorization header for APIs</li>
                  <li>Implement CORS properly</li>
                  <li>Validate origin in callbacks</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0">Secret Management</h6>
              </div>
              <div class="card-body">
                <ul class="small mb-0">
                  <li>Use strong, random secrets (32+ chars)</li>
                  <li>Store in environment variables</li>
                  <li>Never commit secrets to git</li>
                  <li>Rotate secrets periodically</li>
                  <li>Use different secrets per environment</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-4">
          <i class="fas fa-tools me-2"></i>
          <strong>Testing Tool:</strong> Visit <a href="https://jwt.io" target="_blank" class="alert-link">jwt.io</a> to decode and inspect JWT tokens (don't paste production tokens!). You can verify signatures by pasting your JWT_SECRET in the "Verify Signature" section.
        </div>
      </div>

      <div id="user-handler-api" class="section-content">
        <h1>User Handler API</h1>
        <p class="lead">The unique V.3 feature - Decoupled authorization architecture</p>

        <div class="alert alert-success">
          <i class="fas fa-star me-2"></i>
          <strong>What makes SSO-Authen V.3 unique:</strong> Instead of managing users centrally, SSO-Authen delegates user creation and role assignment to YOUR application. This keeps authentication and authorization completely separate.
        </div>

        <h3>Why User Handler API?</h3>
        <p>Traditional SSO systems create a central user database, forcing you to synchronize users, manage roles in multiple places, and deal with complex permission systems. SSO-Authen V.3 takes a different approach:</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-times-circle me-2"></i>Traditional SSO</h5>
              </div>
              <div class="card-body">
                <ul>
                  <li>SSO manages all user data</li>
                  <li>Applications query SSO for user info</li>
                  <li>Roles managed in SSO admin panel</li>
                  <li>User synchronization headaches</li>
                  <li>Tight coupling with SSO system</li>
                  <li>Complex permission mapping</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>SSO-Authen V.3</h5>
              </div>
              <div class="card-body">
                <ul>
                  <li>Your app manages its own users</li>
                  <li>SSO only handles authentication</li>
                  <li>You control roles and permissions</li>
                  <li>No synchronization needed</li>
                  <li>Loose coupling, high flexibility</li>
                  <li>Each app has its own user model</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">How It Works</h3>
        <p>After authenticating with the OIDC provider, SSO-Authen calls YOUR application's User Handler API:</p>

        <div class="card mb-4">
          <div class="card-body">
            <ol class="mb-0">
              <li><strong>User authenticates</strong> with OIDC provider (e.g., PSU SSO)</li>
              <li><strong>SSO-Authen receives</strong> user data from OIDC provider (email, name, etc.)</li>
              <li><strong>SSO-Authen normalizes</strong> the data to a standard format</li>
              <li><strong>SSO-Authen calls YOUR</strong> User Handler endpoint with normalized data</li>
              <li><strong>Your application</strong> finds or creates the user in YOUR database</li>
              <li><strong>Your application</strong> assigns roles based on YOUR business logic</li>
              <li><strong>Your application returns</strong> user data with internal ID and role</li>
              <li><strong>SSO-Authen generates</strong> JWT with YOUR user data</li>
            </ol>
          </div>
        </div>

        <div class="alert alert-info">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Key Insight:</strong> SSO-Authen never stores user data. It only facilitates the authentication flow and packages YOUR user data into a JWT.
        </div>

        <h3>API Contract</h3>
        <p>You must implement an HTTP POST endpoint that accepts normalized user data and returns your application's user data:</p>

        <div class="endpoint-card">
          <div class="endpoint-header">
            <div>
              <span class="http-method method-post">POST</span>
              <strong>{your_user_handler_endpoint}</strong>
            </div>
            <span class="badge bg-warning text-dark">Your Implementation</span>
          </div>
          <div class="card-body">
            <h5>Request Headers</h5>
            <table class="table table-bordered parameter-table">
              <thead>
                <tr>
                  <th>Header</th>
                  <th>Value</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>Content-Type</code></td>
                  <td><code>application/json</code></td>
                  <td>Request body is JSON</td>
                </tr>
                <tr>
                  <td><code>X-API-Secret</code></td>
                  <td><code>{your_api_secret_key}</code></td>
                  <td>For authenticating the request from SSO-Authen</td>
                </tr>
              </tbody>
            </table>

            <h5>Request Body</h5>
            <p>SSO-Authen sends normalized user data:</p>
            <div class="code-example">
              <div class="code-content">
                <pre><code class="language-json">{
  "normalizedUser": {
    "email": "somchai.jaidee@psu.ac.th",
    "name": "à¸ªà¸¡à¸Šà¸²à¸¢ à¹ƒà¸ˆà¸”à¸µ",
    "given_name": "à¸ªà¸¡à¸Šà¸²à¸¢",
    "family_name": "à¹ƒà¸ˆà¸”à¸µ",
    "oid": "12345-67890-abcde",        // OIDC provider's user ID
    "preferred_username": "somchai.j",
    "sub": "12345-67890-abcde"         // OIDC subject identifier
  }
}</code></pre>
              </div>
            </div>

            <h6>normalizedUser Fields</h6>
            <table class="table table-bordered table-sm parameter-table">
              <thead>
                <tr>
                  <th>Field</th>
                  <th>Type</th>
                  <th>Guaranteed</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>email</code></td>
                  <td>string</td>
                  <td><span class="badge bg-success">Yes</span></td>
                  <td>User's email address (always present)</td>
                </tr>
                <tr>
                  <td><code>name</code></td>
                  <td>string</td>
                  <td><span class="badge bg-success">Yes</span></td>
                  <td>Full name (always present)</td>
                </tr>
                <tr>
                  <td><code>given_name</code></td>
                  <td>string</td>
                  <td><span class="badge bg-warning text-dark">Maybe</span></td>
                  <td>First name (if available from provider)</td>
                </tr>
                <tr>
                  <td><code>family_name</code></td>
                  <td>string</td>
                  <td><span class="badge bg-warning text-dark">Maybe</span></td>
                  <td>Last name (if available from provider)</td>
                </tr>
                <tr>
                  <td><code>oid</code></td>
                  <td>string</td>
                  <td><span class="badge bg-warning text-dark">Maybe</span></td>
                  <td>Object ID from OIDC provider</td>
                </tr>
                <tr>
                  <td><code>sub</code></td>
                  <td>string</td>
                  <td><span class="badge bg-warning text-dark">Maybe</span></td>
                  <td>Subject identifier from OIDC provider</td>
                </tr>
                <tr>
                  <td><code>preferred_username</code></td>
                  <td>string</td>
                  <td><span class="badge bg-warning text-dark">Maybe</span></td>
                  <td>Preferred username from provider</td>
                </tr>
              </tbody>
            </table>

            <div class="alert alert-info mt-3">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Note:</strong> Only <code>email</code> and <code>name</code> are guaranteed. Other fields depend on what the OIDC provider returns. Always check field existence before using.
            </div>

            <h5>Response (Your Implementation)</h5>
            <p>Your endpoint MUST return JSON with user data from YOUR database:</p>
            <div class="code-example">
              <div class="code-content">
                <pre><code class="language-json">{
  "id": 123,                          // Required: Your internal user ID
  "email": "somchai.jaidee@psu.ac.th", // Required: User's email
  "name": "à¸ªà¸¡à¸Šà¸²à¸¢ à¹ƒà¸ˆà¸”à¸µ",              // Required: User's name
  "role": "admin",                     // Optional: User's role in YOUR app
  "department": "IT",                  // Optional: Any additional fields
  "permissions": ["read", "write"]     // Optional: Custom data
}</code></pre>
              </div>
            </div>

            <h6>Required Response Fields</h6>
            <table class="table table-bordered table-sm parameter-table">
              <thead>
                <tr>
                  <th>Field</th>
                  <th>Type</th>
                  <th>Required</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>id</code></td>
                  <td>string/number</td>
                  <td><span class="badge-required">Required</span></td>
                  <td>Your application's internal user ID (primary key)</td>
                </tr>
                <tr>
                  <td><code>email</code></td>
                  <td>string</td>
                  <td><span class="badge-required">Required</span></td>
                  <td>User's email address</td>
                </tr>
                <tr>
                  <td><code>name</code></td>
                  <td>string</td>
                  <td><span class="badge-required">Required</span></td>
                  <td>User's display name</td>
                </tr>
                <tr>
                  <td><code>role</code></td>
                  <td>string</td>
                  <td><span class="badge-optional">Optional</span></td>
                  <td>User's role (e.g., "admin", "user", "editor")</td>
                </tr>
                <tr>
                  <td colspan="4" class="text-muted"><em>...any other fields you want in the JWT token</em></td>
                </tr>
              </tbody>
            </table>

            <div class="alert alert-warning mt-3">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Important:</strong> All fields you return will be included in the JWT token. Don't include sensitive data like passwords or tokens!
            </div>

            <h5>Error Responses</h5>
            <p>If your endpoint encounters an error, return appropriate HTTP status codes:</p>
            <div class="row">
              <div class="col-md-6">
                <div class="response-example">
                  <h6>401 Unauthorized</h6>
                  <pre><code class="language-json">{
  "error": "Invalid API secret"
}</code></pre>
                  <p class="small">When <code>X-API-Secret</code> header doesn't match</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="response-example">
                  <h6>500 Internal Server Error</h6>
                  <pre><code class="language-json">{
  "error": "Database connection failed"
}</code></pre>
                  <p class="small">When your application encounters an error</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Implementation Examples</h3>
        
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('handler-impl-php')">
              PHP (Laravel)
            </button>
            <button class="code-tab" onclick="showCodeTab('handler-impl-node')">
              Node.js (Express)
            </button>
            <button class="code-tab" onclick="showCodeTab('handler-impl-python')">
              Python (Flask)
            </button>
          </div>
          <div class="code-content">
            <div id="handler-impl-php" class="code-block active">
              <pre><code class="language-php">&lt;?php
// routes/api.php (Laravel)
Route::post('/sso-user-handler', function (Request $request) {
    // 1. Verify API Secret
    if ($request->header('X-API-Secret') !== config('app.api_secret')) {
        return response()->json(['error' => 'Unauthorized'], 401);
    }
    
    // 2. Get normalized user data
    $normalizedUser = $request->input('normalizedUser');
    $email = $normalizedUser['email'];
    $name = $normalizedUser['name'];
    
    // 3. Find or create user
    $user = User::firstOrCreate(
        ['email' => $email],
        [
            'name' => $name,
            'email_verified_at' => now(),
        ]
    );
    
    // 4. Assign role based on business logic
    if (str_ends_with($email, '@admin.psu.ac.th')) {
        $user->role = 'admin';
    } else if (str_ends_with($email, '@psu.ac.th')) {
        $user->role = 'staff';
    } else {
        $user->role = 'user';
    }
    $user->save();
    
    // 5. Return user data (will be included in JWT)
    return response()->json([
        'id' => $user->id,
        'email' => $user->email,
        'name' => $user->name,
        'role' => $user->role,
        'department' => $user->department,
    ]);
});</code></pre>
            </div>
            <div id="handler-impl-node" class="code-block">
              <pre><code class="language-javascript">// Express.js implementation
const express = require('express');
const User = require('./models/User');
const app = express();

app.post('/api/sso-user-handler', async (req, res) => {
  try {
    // 1. Verify API Secret
    if (req.headers['x-api-secret'] !== process.env.API_SECRET) {
      return res.status(401).json({ error: 'Unauthorized' });
    }
    
    // 2. Get normalized user data
    const { normalizedUser } = req.body;
    const email = normalizedUser.email;
    const name = normalizedUser.name;
    
    // 3. Find or create user
    let user = await User.findOne({ email });
    if (!user) {
      user = await User.create({
        email,
        name,
        emailVerified: true
      });
    }
    
    // 4. Assign role based on business logic
    if (email.endsWith('@admin.psu.ac.th')) {
      user.role = 'admin';
    } else if (email.endsWith('@psu.ac.th')) {
      user.role = 'staff';
    } else {
      user.role = 'user';
    }
    await user.save();
    
    // 5. Return user data (will be included in JWT)
    res.json({
      id: user._id,
      email: user.email,
      name: user.name,
      role: user.role,
      department: user.department
    });
    
  } catch (error) {
    console.error('User handler error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});</code></pre>
            </div>
            <div id="handler-impl-python" class="code-block">
              <pre><code class="language-python"># Flask implementation
from flask import Flask, request, jsonify
from models import User, db
import os

app = Flask(__name__)

@app.route('/api/sso-user-handler', methods=['POST'])
def sso_user_handler():
    try:
        # 1. Verify API Secret
        if request.headers.get('X-API-Secret') != os.getenv('API_SECRET'):
            return jsonify({'error': 'Unauthorized'}), 401
        
        # 2. Get normalized user data
        normalized_user = request.json.get('normalizedUser')
        email = normalized_user['email']
        name = normalized_user['name']
        
        # 3. Find or create user
        user = User.query.filter_by(email=email).first()
        if not user:
            user = User(email=email, name=name, email_verified=True)
            db.session.add(user)
        
        # 4. Assign role based on business logic
        if email.endswith('@admin.psu.ac.th'):
            user.role = 'admin'
        elif email.endswith('@psu.ac.th'):
            user.role = 'staff'
        else:
            user.role = 'user'
        
        db.session.commit()
        
        # 5. Return user data (will be included in JWT)
        return jsonify({
            'id': user.id,
            'email': user.email,
            'name': user.name,
            'role': user.role,
            'department': user.department
        })
        
    except Exception as e:
        print(f'User handler error: {str(e)}')
        return jsonify({'error': 'Internal server error'}), 500</code></pre>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Advanced: Role Assignment Logic</h3>
        <p>You have complete freedom to implement any role assignment logic in your User Handler:</p>

        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Email-based Rules</h6>
              </div>
              <div class="card-body">
                <pre><code class="language-php">// Assign role by email domain
if (str_ends_with($email, '@admin.psu.ac.th')) {
    $role = 'admin';
} else if (str_ends_with($email, '@psu.ac.th')) {
    $role = 'staff';
} else {
    $role = 'guest';
}</code></pre>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">Database Lookup</h6>
              </div>
              <div class="card-body">
                <pre><code class="language-php">// Check against pre-defined admin list
$admin = Admin::where('email', $email)->first();
if ($admin) {
    $role = $admin->role; // 'super_admin', 'admin', etc.
} else {
    $role = 'user';
}</code></pre>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">External API</h6>
              </div>
              <div class="card-body">
                <pre><code class="language-php">// Query HR system for department/role
$hrData = Http::get("https://hr.psu.ac.th/api/user/$email");
if ($hrData->ok()) {
    $role = $hrData->json()['position'];
    $dept = $hrData->json()['department'];
}</code></pre>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">First-Login Default</h6>
              </div>
              <div class="card-body">
                <pre><code class="language-php">// New users get default role
if (!$user->exists) {
    $role = 'pending_approval';
    // Send notification to admin
    Mail::to('admin@app.com')->send(
        new NewUserNotification($user)
    );
}</code></pre>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Testing Your User Handler</h3>
        <p>You can test your User Handler endpoint independently before integrating with SSO-Authen:</p>

        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('test-curl')">
              cURL
            </button>
            <button class="code-tab" onclick="showCodeTab('test-postman')">
              JavaScript (Fetch)
            </button>
          </div>
          <div class="code-content">
            <div id="test-curl" class="code-block active">
              <pre><code class="language-bash">curl -X POST https://yourapp.com/api/sso-user-handler \
  -H "Content-Type: application/json" \
  -H "X-API-Secret: your_api_secret_key" \
  -d '{
    "normalizedUser": {
      "email": "test@psu.ac.th",
      "name": "Test User",
      "given_name": "Test",
      "family_name": "User"
    }
  }'

# Expected response:
# {"id":1,"email":"test@psu.ac.th","name":"Test User","role":"user"}</code></pre>
            </div>
            <div id="test-postman" class="code-block">
              <pre><code class="language-javascript">fetch('https://yourapp.com/api/sso-user-handler', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Secret': 'your_api_secret_key'
  },
  body: JSON.stringify({
    normalizedUser: {
      email: 'test@psu.ac.th',
      name: 'Test User',
      given_name: 'Test',
      family_name: 'User'
    }
  })
})
.then(res => res.json())
.then(data => console.log('User data:', data))
.catch(err => console.error('Error:', err));</code></pre>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Security Considerations</h3>
        <div class="alert alert-danger">
          <h5><i class="fas fa-shield-alt me-2"></i>Critical Security Points</h5>
          <ul class="mb-0">
            <li><strong>Always verify X-API-Secret:</strong> Reject requests with invalid/missing secret</li>
            <li><strong>Use HTTPS only:</strong> Never expose this endpoint over HTTP</li>
            <li><strong>Rate limiting:</strong> Implement rate limiting to prevent abuse</li>
            <li><strong>Validate email format:</strong> Ensure email is properly formatted</li>
            <li><strong>Don't return sensitive data:</strong> Don't include passwords, tokens, or sensitive info in response</li>
            <li><strong>Log all requests:</strong> Keep audit logs for security monitoring</li>
            <li><strong>Handle errors gracefully:</strong> Don't expose internal error details</li>
          </ul>
        </div>

        <h3>Configuration in Admin Panel</h3>
        <p>After implementing your User Handler, configure it in the SSO-Authen admin panel:</p>
        <ol>
          <li>Go to <strong>Client Management</strong></li>
          <li>Edit your client application</li>
          <li>Set <code>user_handler_endpoint</code> to your API URL (e.g., https://yourapp.com/api/sso-user-handler)</li>
          <li>Set <code>api_secret_key</code> to a strong random string (will be sent in X-API-Secret header)</li>
          <li>Save configuration</li>
        </ol>

        <div class="alert alert-success mt-4">
          <i class="fas fa-rocket me-2"></i>
          <strong>You're in control!</strong> The User Handler API gives you complete flexibility to manage users, roles, and permissions according to YOUR application's business logic. SSO-Authen simply facilitates the authentication and packages your data into a JWT.
        </div>
      </div>

      <div id="logout-endpoint" class="section-content">
        <h1>Logout Endpoint</h1>
        <p class="lead">Signing out users - /public/logout.php</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Important:</strong> The logout endpoint destroys the SSO-Authen session and redirects back to your application. Your application is responsible for clearing its own session/state.
        </div>

        <div class="endpoint-card">
          <div class="endpoint-header">
            <div>
              <span class="http-method method-get">GET</span>
              <strong>/public/logout.php</strong>
            </div>
            <span class="badge bg-primary">Public Endpoint</span>
          </div>
          <div class="card-body">
            <h5>Description</h5>
            <p>This endpoint destroys the SSO-Authen session and redirects the user back to your application. It does NOT log the user out from the OIDC provider - if the provider has an active session, the user may be automatically logged back in on next login attempt.</p>

            <h5>Query Parameters</h5>
            <table class="table table-bordered parameter-table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Type</th>
                  <th>Required</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>post_logout_redirect_uri</code></td>
                  <td>string</td>
                  <td><span class="badge-required">Required</span></td>
                  <td>The URL where the user should be redirected after logout. Must match the registered <code>post_logout_redirect_uri</code> or <code>app_redirect_uri</code> in your client configuration.</td>
                </tr>
              </tbody>
            </table>

            <h5>Example Request</h5>
            <div class="code-example">
              <div class="code-tabs">
                <button class="code-tab active" onclick="showCodeTab('logout-url')">
                  URL
                </button>
                <button class="code-tab" onclick="showCodeTab('logout-js')">
                  JavaScript
                </button>
                <button class="code-tab" onclick="showCodeTab('logout-php-ex')">
                  PHP
                </button>
              </div>
              <div class="code-content">
                <div id="logout-url" class="code-block active">
                  <pre><code class="language-text">GET https://sso.oas.psu.ac.th/public/logout.php?post_logout_redirect_uri=https%3A%2F%2Fyourapp.com%2F</code></pre>
                </div>
                <div id="logout-js" class="code-block">
                  <pre><code class="language-javascript">function logout() {
  // Clear local session/state first
  localStorage.removeItem('jwt_token');
  localStorage.removeItem('user');
  
  // Redirect to SSO logout
  const params = new URLSearchParams({
    post_logout_redirect_uri: 'https://yourapp.com/'
  });
  
  window.location.href = `https://sso.oas.psu.ac.th/public/logout.php?${params}`;
}</code></pre>
                </div>
                <div id="logout-php-ex" class="code-block">
                  <pre><code class="language-php">&lt;?php
// logout.php in your application
session_start();

// Clear local session
session_destroy();

// Redirect to SSO logout
$logoutUrl = 'https://sso.oas.psu.ac.th/public/logout.php?' . http_build_query([
    'post_logout_redirect_uri' => 'https://yourapp.com/'
]);

header("Location: $logoutUrl");
exit;
?&gt;</code></pre>
                </div>
              </div>
            </div>

            <h5>Response</h5>
            <p>This endpoint does not return JSON. Instead, it:</p>
            <ol>
              <li>Validates the <code>post_logout_redirect_uri</code> is in the allowed list</li>
              <li>Destroys the SSO-Authen PHP session</li>
              <li>Displays a success message using SweetAlert2</li>
              <li>Redirects (HTTP 302) the user to the specified <code>post_logout_redirect_uri</code></li>
            </ol>

            <h5>Success Flow</h5>
            <div class="alert alert-success">
              <strong>On successful logout:</strong>
              <ol class="mb-0">
                <li>User sees "Sign out successful" message</li>
                <li>After 1.5 seconds, redirected to your <code>post_logout_redirect_uri</code></li>
                <li>Your application should clear its own session/state</li>
              </ol>
            </div>

            <h5>Error Responses</h5>
            <p>If validation fails, an error message is displayed:</p>
            
            <div class="row">
              <div class="col-md-6">
                <div class="response-example">
                  <h6>Missing Parameter</h6>
                  <pre><code class="language-json">{
  "title": "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”",
  "message": "No destination URL specified after sign out. (post_logout_redirect_uri is required)",
  "icon": "error"
}</code></pre>
                  <p class="small">User is redirected to SSO-Authen home page</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="response-example">
                  <h6>Unauthorized URI</h6>
                  <pre><code class="language-json">{
  "title": "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”",
  "message": "The specified destination URL is not authorized.",
  "icon": "error"
}</code></pre>
                  <p class="small">User is redirected to SSO-Authen home page</p>
                </div>
              </div>
            </div>

            <h5 class="mt-3">Security Notes</h5>
            <div class="alert alert-warning">
              <ul class="mb-0">
                <li><strong>URI Validation:</strong> The redirect URI must match either <code>post_logout_redirect_uri</code> or <code>app_redirect_uri</code> from your client configuration</li>
                <li><strong>No Open Redirect:</strong> Arbitrary redirect URIs are rejected to prevent phishing attacks</li>
                <li><strong>SSO Session Only:</strong> This only destroys the SSO-Authen session, not the OIDC provider session</li>
                <li><strong>Application Responsibility:</strong> Your application must clear its own session/tokens</li>
              </ul>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Complete Logout Flow</h3>
        <p>A proper logout implementation involves clearing sessions at multiple levels:</p>

        <div class="row">
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">1. Application Session</h6>
              </div>
              <div class="card-body">
                <p><strong>Your Responsibility</strong></p>
                <ul class="small">
                  <li>Clear PHP session</li>
                  <li>Remove JWT from localStorage</li>
                  <li>Clear cookies</li>
                  <li>Reset application state</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">2. SSO-Authen Session</h6>
              </div>
              <div class="card-body">
                <p><strong>Handled by /public/logout.php</strong></p>
                <ul class="small">
                  <li>Destroy SSO-Authen session</li>
                  <li>Clear session cookies</li>
                  <li>Validate redirect URI</li>
                  <li>Redirect back to your app</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">3. OIDC Provider Session</h6>
              </div>
              <div class="card-body">
                <p><strong>Not Handled (Optional)</strong></p>
                <ul class="small">
                  <li>Provider session persists</li>
                  <li>Auto-login on next attempt</li>
                  <li>User must logout from provider separately</li>
                  <li>Contact provider for end_session_endpoint</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Implementation Examples</h3>
        
        <h4>Client-Side Logout (React/Vue/Angular)</h4>
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('logout-react')">
              React
            </button>
            <button class="code-tab" onclick="showCodeTab('logout-vue')">
              Vue.js
            </button>
          </div>
          <div class="code-content">
            <div id="logout-react" class="code-block active">
              <pre><code class="language-javascript">// React logout function
import { useAuth } from './AuthContext';
import { useNavigate } from 'react-router-dom';

function LogoutButton() {
  const { logout } = useAuth();
  const navigate = useNavigate();
  
  const handleLogout = () => {
    // 1. Clear application state
    logout(); // Clears context state
    localStorage.removeItem('jwt_token');
    localStorage.removeItem('user');
    
    // 2. Redirect to SSO logout
    const ssoLogoutUrl = 'https://sso.oas.psu.ac.th/public/logout.php';
    const returnUrl = window.location.origin; // Back to app homepage
    
    window.location.href = `${ssoLogoutUrl}?post_logout_redirect_uri=${encodeURIComponent(returnUrl)}`;
  };
  
  return (
    <button onClick={handleLogout} className="btn btn-danger">
      <i className="fas fa-sign-out-alt me-2"></i>
      Logout
    </button>
  );
}</code></pre>
            </div>
            <div id="logout-vue" class="code-block">
              <pre><code class="language-javascript">// Vue.js logout method
export default {
  methods: {
    logout() {
      // 1. Clear application state
      this.$store.dispatch('auth/logout'); // Clear Vuex state
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('user');
      
      // 2. Redirect to SSO logout
      const ssoLogoutUrl = 'https://sso.oas.psu.ac.th/public/logout.php';
      const returnUrl = window.location.origin;
      
      window.location.href = `${ssoLogoutUrl}?post_logout_redirect_uri=${encodeURIComponent(returnUrl)}`;
    }
  }
}</code></pre>
            </div>
          </div>
        </div>

        <h4 class="mt-3">Server-Side Logout (PHP/Node.js)</h4>
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('logout-php-full')">
              PHP
            </button>
            <button class="code-tab" onclick="showCodeTab('logout-node-full')">
              Node.js (Express)
            </button>
          </div>
          <div class="code-content">
            <div id="logout-php-full" class="code-block active">
              <pre><code class="language-php">&lt;?php
// logout.php - Complete logout implementation
session_start();

// 1. Clear application session
session_unset();
session_destroy();

// 2. Clear session cookie
if (isset($_COOKIE[session_name()])) {
    setcookie(session_name(), '', time() - 3600, '/');
}

// 3. Build SSO logout URL
$ssoLogoutUrl = 'https://sso.oas.psu.ac.th/public/logout.php';
$returnUrl = 'https://yourapp.com/'; // Your app homepage

$logoutUrl = $ssoLogoutUrl . '?' . http_build_query([
    'post_logout_redirect_uri' => $returnUrl
]);

// 4. Redirect to SSO logout
header("Location: $logoutUrl");
exit;
?&gt;</code></pre>
            </div>
            <div id="logout-node-full" class="code-block">
              <pre><code class="language-javascript">// Express.js logout route
const express = require('express');
const router = express.Router();

router.get('/logout', (req, res) => {
  // 1. Clear application session
  req.session.destroy((err) => {
    if (err) {
      console.error('Session destruction error:', err);
    }
    
    // 2. Clear session cookie
    res.clearCookie('connect.sid');
    
    // 3. Build SSO logout URL
    const ssoLogoutUrl = 'https://sso.oas.psu.ac.th/public/logout.php';
    const returnUrl = 'https://yourapp.com/';
    
    const logoutUrl = `${ssoLogoutUrl}?post_logout_redirect_uri=${encodeURIComponent(returnUrl)}`;
    
    // 4. Redirect to SSO logout
    res.redirect(logoutUrl);
  });
});

module.exports = router;</code></pre>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Best Practices</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Recommended</h6>
              </div>
              <div class="card-body">
                <ul class="small mb-0">
                  <li>Always clear local session first</li>
                  <li>Use registered post_logout_redirect_uri</li>
                  <li>Provide clear logout button in UI</li>
                  <li>Show confirmation before logout (optional)</li>
                  <li>Log logout events for auditing</li>
                  <li>Handle logout errors gracefully</li>
                  <li>Clear all client-side storage</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>Avoid</h6>
              </div>
              <div class="card-body">
                <ul class="small mb-0">
                  <li>Don't use arbitrary redirect URIs</li>
                  <li>Don't forget to clear local session</li>
                  <li>Don't expose logout endpoint to CSRF</li>
                  <li>Don't rely only on JavaScript logout</li>
                  <li>Don't leave sensitive data in storage</li>
                  <li>Don't skip URI validation</li>
                  <li>Don't assume provider logout happens</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-success mt-4">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Pro Tip:</strong> Create a dedicated logout page in your application that handles cleanup, then redirects to SSO logout. This gives you more control over the logout process and allows you to show a "logging out..." message.
        </div>
      </div>

      <div id="admin-overview" class="section-content">
        <h1>Admin Panel Overview</h1>
        <p class="lead">Managing SSO-Authen V.3 system through the web interface</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Access:</strong> The Admin Panel is located at <code>https://sso.oas.psu.ac.th/admin/public/</code> and requires administrator authentication.
        </div>

        <h3>Admin Panel Features</h3>
        <p>The Admin Panel provides a comprehensive web interface for managing all aspects of the SSO-Authen system:</p>

        <div class="row">
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h5>
              </div>
              <div class="card-body">
                <p><strong>Real-time System Overview</strong></p>
                <ul class="mb-0">
                  <li>Total registered clients</li>
                  <li>Active client count</li>
                  <li>Authentication requests today</li>
                  <li>Success rate statistics</li>
                  <li>Recent activity log</li>
                  <!-- <li>System health status</li> -->
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Clients Applications</h5>
              </div>
              <div class="card-body">
                <p><strong>Client Management</strong></p>
                <ul class="mb-0">
                  <li>Add new client applications</li>
                  <li>Edit client configurations</li>
                  <li>View client details</li>
                  <li>Activate/deactivate clients</li>
                  <li>Delete clients</li>
                  <li>Search and filter</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Usage Statistics</h5>
              </div>
              <div class="card-body">
                <p><strong>Analytics Dashboard</strong></p>
                <ul class="mb-0">
                  <li>Authentication success rate</li>
                  <li>Top active clients</li>
                  <li>Client usage trends</li>
                  <li>Client activity charts</li>
                  <li>Client activity breakdown</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Admin Users</h5>
              </div>
              <div class="card-body">
                <p><strong>Access Control</strong></p>
                <ul class="mb-0">
                  <li>Manage admin accounts</li>
                  <li>Role-based access control</li>
                  <li>User status management</li>
                  <li>View user activity</li>
                  <li>Security permissions</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-database me-2"></i>Backup & Restore</h5>
              </div>
              <div class="card-body">
                <p><strong>Data Management</strong></p>
                <ul class="mb-0">
                  <li>Create system backups</li>
                  <li>Download backup files</li>
                  <li>Restore from backup</li>
                  <li>Manage backup history</li>
                  <li>Automated backup options</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Settings</h5>
              </div>
              <div class="card-body">
                <p><strong>System Configuration</strong></p>
                <ul class="mb-0">
                  <li>Update JWT secret key</li>
                  <li>View secret history</li>
                  <li>Automatic config.php backup</li>
                  <li>Audit trail logging</li>
                  <li>System preferences</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Accessing the Admin Panel</h3>
        
        <h4>Step 1: Navigate to Admin URL</h4>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">https://sso.oas.psu.ac.th/admin/public/</code></pre>
          </div>
        </div>

        <h4>Step 2: Login</h4>
        <p>Click the login button to authenticate with SSO:</p>
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-body">
                <p><strong>Authentication Method:</strong></p>
                <ul>
                  <li><strong>Development Mode:</strong> One-click login for development environment</li>
                  <li><strong>Production Mode:</strong> Uses SSO authentication with admin_users database</li>
                </ul>
                <div class="alert alert-info mb-0">
                  <small><i class="fas fa-info-circle me-2"></i><strong>Note:</strong> Admin credentials are managed in the <code>admin_users</code> database table. Contact your system administrator for access.</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Admin Panel Navigation</h3>
        <p>The Admin Panel features a sidebar navigation with the following sections:</p>

        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-bars me-2"></i>Main Menu</h6>
                <ul>
                  <li><strong>Dashboard</strong> - System overview and statistics</li>
                  <li><strong>Clients</strong> - Manage client applications</li>
                  <li><strong>Usage Statistics</strong> - Analytics and monitoring</li>
                  <li><strong>Admin Users</strong> - User management and access control</li>
                  <li><strong>Backup & Restore</strong> - Data backup and recovery</li>
                  <li><strong>Settings</strong> - System configuration</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-info-circle me-2"></i>Features</h6>
                <ul>
                  <li><strong>Real-time Stats</strong> - Auto-refresh every 30 seconds</li>
                  <li><strong>Search & Filter</strong> - Quick client lookup</li>
                  <li><strong>User Info Display</strong> - Shows logged-in admin</li>
                  <li><strong>Audit Logging</strong> - Track all admin actions</li>
                  <li><strong>Responsive Design</strong> - Works on mobile/tablet</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Dashboard Overview</h3>
        <p>The main dashboard displays real-time statistics in card format:</p>

        <div class="row">
          <div class="col-md-3">
            <div class="card text-center" style="border-left: 4px solid #3498DB;">
              <div class="card-body">
                <h6 class="text-muted">Total Clients</h6>
                <h2 class="mb-0" style="color: #3498DB;">15</h2>
                <small>All registered clients</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center" style="border-left: 4px solid #2ECC71;">
              <div class="card-body">
                <h6 class="text-muted">Active Clients</h6>
                <h2 class="mb-0" style="color: #2ECC71;">12</h2>
                <small>Currently active</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center" style="border-left: 4px solid #E67E22;">
              <div class="card-body">
                <h6 class="text-muted">Requests Today</h6>
                <h2 class="mb-0" style="color: #E67E22;">247</h2>
                <small>Authentication requests</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center" style="border-left: 4px solid #9B59B6;">
              <div class="card-body">
                <h6 class="text-muted">Success Rate</h6>
                <h2 class="mb-0" style="color: #9B59B6;">95.5%</h2>
                <small>Authentication success</small>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Security Best Practices</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Recommended</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Secure admin access with SSO authentication</li>
                  <li>Use strong passwords (12+ characters)</li>
                  <li>Enable HTTPS for admin access</li>
                  <li>Regularly backup client database</li>
                  <li>Monitor authentication logs</li>
                  <li>Update JWT secret periodically</li>
                  <li>Review audit logs regularly</li>
                  <li>Limit admin user access</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>Avoid</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Don't share admin credentials</li>
                  <li>Don't access admin over HTTP</li>
                  <li>Don't ignore backup schedules</li>
                  <li>Don't delete clients without backup</li>
                  <li>Don't expose admin panel publicly</li>
                  <li>Don't disable security features</li>
                  <li>Don't ignore audit trail warnings</li>
                  <li>Don't forget to logout after use</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-warning mt-4">
          <i class="fas fa-shield-alt me-2"></i>
          <strong>Production Deployment:</strong> Before deploying to production, ensure you've configured proper authentication, enabled HTTPS, set up regular database backups, and reviewed all security settings.
        </div>
      </div>

      <div id="client-management" class="section-content">
        <h1>Client Management</h1>
        <p class="lead">Managing registered client applications via Admin Panel</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Location:</strong> Admin Panel â†’ Client Management or direct URL: <code>https://sso.oas.psu.ac.th/admin/public/client-management.php</code>
        </div>

        <h3>Overview</h3>
        <p>The Client Management page allows administrators to manage all registered client applications in the SSO system. Each client represents an application that uses SSO-Authen for authentication.</p>

        <h3>Client Table Columns</h3>
        <table class="table table-bordered parameter-table">
          <thead>
            <tr>
              <th>Column</th>
              <th>Description</th>
              <th>Example</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>client_id</code></td>
              <td>Unique identifier for the client application</td>
              <td><code>myapp_web_2024</code></td>
            </tr>
            <tr>
              <td><code>client_name</code></td>
              <td>Human-readable name of the application</td>
              <td><code>My Web Application</code></td>
            </tr>
            <tr>
              <td><code>app_redirect_uri</code></td>
              <td>Callback URL after authentication</td>
              <td><code>https://myapp.com/callback</code></td>
            </tr>
            <tr>
              <td><code>post_logout_redirect_uri</code></td>
              <td>Redirect URL after logout</td>
              <td><code>https://myapp.com/</code></td>
            </tr>
            <tr>
              <td><code>user_handler_endpoint</code></td>
              <td>API endpoint for User Handler (JWT Mode only)</td>
              <td><code>https://myapp.com/api/sso-handler</code></td>
            </tr>
            <tr>
              <td><code>api_secret_key</code></td>
              <td>Secret key for API authentication</td>
              <td><code>sk_live_xxxxxxx...</code></td>
            </tr>
            <tr>
              <td><code>status</code></td>
              <td>Client status: active, inactive, or suspended</td>
              <td><code>active</code></td>
            </tr>
            <tr>
              <td><code>authentication_mode</code></td>
              <td>JWT Mode or Legacy Mode (auto-determined)</td>
              <td><code>JWT Mode</code></td>
            </tr>
            <tr>
              <td><code>created_at</code></td>
              <td>Client registration timestamp</td>
              <td><code>2024-01-15 10:30:00</code></td>
            </tr>
          </tbody>
        </table>

        <div class="alert alert-success">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Auto-Detection:</strong> Authentication Mode is automatically determined based on <code>user_handler_endpoint</code>:
          <ul class="mb-0">
            <li><strong>JWT Mode:</strong> When user_handler_endpoint has a value</li>
            <li><strong>Legacy Mode:</strong> When user_handler_endpoint is empty/null</li>
          </ul>
        </div>

        <h3 class="mt-4">Adding a New Client</h3>
        <p>To register a new client application:</p>

        <div class="card">
          <div class="card-body">
            <h5>Step-by-Step Guide</h5>
            <ol>
              <li><strong>Click "Add New Client" button</strong> at the top of the page</li>
              <li><strong>Fill in the form fields:</strong>
                <ul>
                  <li><strong>Client ID:</strong> Unique identifier (alphanumeric, hyphens, underscores)</li>
                  <li><strong>Client Name:</strong> Display name for the application</li>
                  <li><strong>Redirect URI:</strong> Your application's callback URL</li>
                  <li><strong>Post-Logout URI:</strong> Where to redirect after logout</li>
                  <li><strong>User Handler Endpoint:</strong> Your API endpoint (for JWT Mode) or leave empty (for Legacy Mode)</li>
                  <li><strong>API Secret Key:</strong> Auto-generated or custom</li>
                  <li><strong>Status:</strong> Active, Inactive, or Suspended</li>
                </ul>
              </li>
              <li><strong>Click "Save Client"</strong></li>
              <li><strong>Note down the client_id and api_secret_key</strong> for your application</li>
            </ol>
          </div>
        </div>

        <h4 class="mt-3">Form Validation</h4>
        <div class="row">
          <div class="col-md-6">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0">Required Fields</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Client ID (must be unique)</li>
                  <li>Client Name</li>
                  <li>Redirect URI (must be valid URL)</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-warning">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">Optional Fields</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Post-Logout Redirect URI</li>
                  <li>User Handler Endpoint</li>
                  <li>API Secret Key (auto-generated if empty)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Editing a Client</h3>
        <p>To modify an existing client configuration:</p>
        <ol>
          <li>Click the <span class="badge bg-warning"><i class="fas fa-edit"></i> Edit</span> button in the Actions column</li>
          <li>Update the desired fields in the modal form</li>
          <li>Click "Save Changes"</li>
        </ol>

        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Important:</strong> Changing the <code>app_redirect_uri</code> or <code>api_secret_key</code> will require updating your client application's configuration. Users won't be able to authenticate until you update your app.
        </div>

        <h3 class="mt-4">Viewing Client Details</h3>
        <p>Click the <span class="badge bg-info"><i class="fas fa-eye"></i> View</span> button to see full client information:</p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-json">{
  "client_id": "myapp_web_2024",
  "client_name": "My Web Application",
  "app_redirect_uri": "https://myapp.com/callback",
  "post_logout_redirect_uri": "https://myapp.com/",
  "user_handler_endpoint": "https://myapp.com/api/sso-handler",
  "api_secret_key": "sk_live_xxxxxxxxxxxxxxxx",
  "status": "active",
  "authentication_mode": "JWT Mode",
  "created_at": "2024-01-15 10:30:00",
  "updated_at": "2024-01-20 15:45:00",
  "created_by": "admin"
}</code></pre>
          </div>
        </div>

        <h3 class="mt-4">Deleting a Client</h3>
        <p>To remove a client application:</p>
        <ol>
          <li>Click the <span class="badge bg-danger"><i class="fas fa-trash"></i> Delete</span> button</li>
          <li>Confirm the deletion in the popup dialog</li>
          <li>Client will be permanently removed from the database</li>
        </ol>

        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> Deleting a client is permanent and cannot be undone. Users of that application will no longer be able to authenticate. Always create a backup before deleting clients.
        </div>

        <h3 class="mt-4">Client Status Management</h3>
        <p>You can control client access by changing their status:</p>

        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Status</th>
              <th>Description</th>
              <th>Authentication</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="badge bg-success">Active</span></td>
              <td>Client is fully operational</td>
              <td><i class="fas fa-check text-success"></i> Allowed</td>
            </tr>
            <tr>
              <td><span class="badge bg-secondary">Inactive</span></td>
              <td>Client is temporarily disabled</td>
              <td><i class="fas fa-times text-danger"></i> Blocked</td>
            </tr>
            <tr>
              <td><span class="badge bg-danger">Suspended</span></td>
              <td>Client is suspended (security/policy violation)</td>
              <td><i class="fas fa-times text-danger"></i> Blocked</td>
            </tr>
          </tbody>
        </table>

        <h3 class="mt-4">Search and Filter</h3>
        <p>The Client Management page includes powerful search functionality:</p>

        <div class="card">
          <div class="card-body">
            <h6><i class="fas fa-search me-2"></i>Search Capabilities</h6>
            <ul>
              <li><strong>Real-time search:</strong> Results update as you type (with debouncing)</li>
              <li><strong>Search by:</strong> Client ID, Client Name, Redirect URI</li>
              <li><strong>Filter by status:</strong> All, Active, Inactive, Suspended</li>
              <li><strong>Filter by mode:</strong> All, JWT Mode, Legacy Mode</li>
            </ul>
          </div>
        </div>

        <h3 class="mt-4">Database Schema</h3>
        <p>Clients are stored in the <code>clients</code> table with the following structure:</p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-sql">CREATE TABLE clients (
  id INT AUTO_INCREMENT PRIMARY KEY,
  client_id VARCHAR(255) UNIQUE NOT NULL,
  client_name VARCHAR(255) NOT NULL,
  client_secret VARCHAR(255),
  app_redirect_uri TEXT NOT NULL,
  post_logout_redirect_uri TEXT,
  user_handler_endpoint TEXT,
  api_secret_key VARCHAR(255),
  allowed_scopes TEXT,
  status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by VARCHAR(100)
);</code></pre>
          </div>
        </div>

        <h3 class="mt-4">API Endpoints (Internal)</h3>
        <p>The Client Management page uses these internal API endpoints:</p>

        <table class="table table-bordered parameter-table">
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Method</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/admin/api/clients</code></td>
              <td><span class="badge bg-info">GET</span></td>
              <td>Get all clients</td>
            </tr>
            <tr>
              <td><code>/admin/api/clients</code></td>
              <td><span class="badge bg-success">POST</span></td>
              <td>Create new client</td>
            </tr>
            <tr>
              <td><code>/admin/api/clients/{id}</code></td>
              <td><span class="badge bg-warning">PUT</span></td>
              <td>Update client</td>
            </tr>
            <tr>
              <td><code>/admin/api/clients/{id}</code></td>
              <td><span class="badge bg-danger">DELETE</span></td>
              <td>Delete client</td>
            </tr>
            <tr>
              <td><code>/admin/api/stats</code></td>
              <td><span class="badge bg-info">GET</span></td>
              <td>Get client statistics</td>
            </tr>
          </tbody>
        </table>

        <h3 class="mt-4">Best Practices</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Do</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Use descriptive client names</li>
                  <li>Use HTTPS for all URIs</li>
                  <li>Keep API secrets secure</li>
                  <li>Set appropriate status for unused clients</li>
                  <li>Document client configurations</li>
                  <li>Regular audit of active clients</li>
                  <li>Backup before bulk changes</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>Don't</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Don't use HTTP for redirect URIs</li>
                  <li>Don't share API secret keys</li>
                  <li>Don't delete clients without backup</li>
                  <li>Don't use same client_id for multiple apps</li>
                  <li>Don't leave test clients active in production</li>
                  <li>Don't ignore inactive clients</li>
                  <li>Don't expose admin panel publicly</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-4">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Pro Tip:</strong> Use the client_id naming convention like <code>appname_environment_year</code> (e.g., <code>myapp_prod_2024</code>) to easily identify and manage clients.
        </div>
      </div>

      <div id="dashboard-api" class="section-content">
        <h1>Dashboard API</h1>
        <p class="lead">Statistics and monitoring endpoints for the Admin Dashboard</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Note:</strong> These are internal API endpoints used by the Admin Panel. They require admin authentication.
        </div>

        <h3>Statistics Endpoint</h3>
        
        <div class="endpoint-card">
          <div class="endpoint-header">
            <div>
              <span class="http-method method-get">GET</span>
              <strong>/admin/api/stats</strong>
            </div>
            <span class="badge bg-warning text-dark">Admin Only</span>
          </div>
          <div class="card-body">
            <h5>Description</h5>
            <p>Returns real-time statistics for the admin dashboard, including client counts, request counts, and system health information.</p>

            <h5>Authentication</h5>
            <p>Requires active admin session (authenticated via admin login)</p>

            <h5>Example Request</h5>
            <div class="code-example">
              <div class="code-tabs">
                <button class="code-tab active" onclick="showCodeTab('stats-fetch')">
                  JavaScript (Fetch)
                </button>
                <button class="code-tab" onclick="showCodeTab('stats-curl')">
                  cURL
                </button>
              </div>
              <div class="code-content">
                <div id="stats-fetch" class="code-block active">
                  <pre><code class="language-javascript">// Called from admin dashboard
fetch('/admin/api/stats')
  .then(res => res.json())
  .then(data => {
    console.log('Total Clients:', data.total_clients);
    console.log('Active Clients:', data.active_clients);
    console.log('Requests Today:', data.total_requests_today);
    console.log('Success Rate:', data.success_rate + '%');
    console.log('Top Clients:', data.top_client_activities);
  })
  .catch(err => console.error('Error:', err));</code></pre>
                </div>
                <div id="stats-curl" class="code-block">
                  <pre><code class="language-bash">curl -X GET 'https://sso.oas.psu.ac.th/admin/api/stats' \
  -H 'Cookie: PHPSESSID=your_session_id' \
  -H 'Content-Type: application/json'</code></pre>
                </div>
              </div>
            </div>

            <h5>Response (Success)</h5>
            <p>Returns JSON object with current statistics:</p>
            <div class="code-example">
              <div class="code-content">
                <pre><code class="language-json">{
  "total_clients": 15,
  "active_clients": 12,
  "inactive_clients": 2,
  "suspended_clients": 1,
  "total_requests_today": 247,
  "total_requests": 8542,
  "success_rate": 95.5,
  "recent_activities_count": 50,
  "top_client_activities": [
    {
      "client_id": "myapp_web_2024",
      "client_name": "My Web Application",
      "total_requests": 1234,
      "success_count": 1180,
      "failed_count": 54
    },
    {
      "client_id": "legacy_php_app",
      "client_name": "Legacy PHP Application",
      "total_requests": 856,
      "success_count": 820,
      "failed_count": 36
    }
  ],
  "system_usage_trend": [
    {"date": "2024-01-14", "requests": 1205, "success": 1150, "failed": 55},
    {"date": "2024-01-15", "requests": 1187, "success": 1130, "failed": 57},
    {"date": "2024-01-16", "requests": 1243, "success": 1185, "failed": 58},
    {"date": "2024-01-17", "requests": 1298, "success": 1240, "failed": 58},
    {"date": "2024-01-18", "requests": 1350, "success": 1292, "failed": 58},
    {"date": "2024-01-19": "requests": 1312, "success": 1255, "failed": 57},
    {"date": "2024-01-20", "requests": 947, "success": 905, "failed": 42}
  ]
}</code></pre>
              </div>
            </div>

            <h5>Response Fields</h5>
            <table class="table table-bordered parameter-table">
              <thead>
                <tr>
                  <th>Field</th>
                  <th>Type</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>total_clients</code></td>
                  <td>integer</td>
                  <td>Total number of registered clients (all statuses)</td>
                </tr>
                <tr>
                  <td><code>active_clients</code></td>
                  <td>integer</td>
                  <td>Number of clients with status = 'active'</td>
                </tr>
                <tr>
                  <td><code>inactive_clients</code></td>
                  <td>integer</td>
                  <td>Number of clients with status = 'inactive'</td>
                </tr>
                <tr>
                  <td><code>suspended_clients</code></td>
                  <td>integer</td>
                  <td>Number of clients with status = 'suspended'</td>
                </tr>
                <tr>
                  <td><code>total_requests_today</code></td>
                  <td>integer</td>
                  <td>Total number of authentication requests today (from audit_logs)</td>
                </tr>
                <tr>
                  <td><code>total_requests</code></td>
                  <td>integer</td>
                  <td>Total number of all authentication requests</td>
                </tr>
                <tr>
                  <td><code>success_rate</code></td>
                  <td>float</td>
                  <td>Success rate percentage (0-100) calculated from auth_success / total_auth_attempts</td>
                </tr>
                <tr>
                  <td><code>recent_activities_count</code></td>
                  <td>integer</td>
                  <td>Number of recent activities (last 50 records from audit_logs)</td>
                </tr>
                <tr>
                  <td><code>top_client_activities</code></td>
                  <td>array</td>
                  <td>Top 5 most active clients with their statistics (30 days)</td>
                </tr>
                <tr>
                  <td><code>system_usage_trend</code></td>
                  <td>array</td>
                  <td>7-day usage trend with daily statistics (requests, success, failed)</td>
                </tr>
              </tbody>
            </table>

            <h5>Error Responses</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="response-example">
                  <h6>401 Unauthorized</h6>
                  <pre><code class="language-json">{
  "success": false,
  "message": "Authentication required"
}</code></pre>
                  <p class="small">When admin session is not active</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="response-example">
                  <h6>500 Internal Server Error</h6>
                  <pre><code class="language-json">{
  "success": false,
  "message": "Database connection failed"
}</code></pre>
                  <p class="small">When database error occurs</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Clients List Endpoint</h3>
        
        <div class="endpoint-card">
          <div class="endpoint-header">
            <div>
              <span class="http-method method-get">GET</span>
              <strong>/admin/api/clients</strong>
            </div>
            <span class="badge bg-warning text-dark">Admin Only</span>
          </div>
          <div class="card-body">
            <h5>Description</h5>
            <p>Returns list of all registered client applications with their configurations.</p>

            <h5>Query Parameters</h5>
            <table class="table table-bordered parameter-table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Type</th>
                  <th>Required</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>status</code></td>
                  <td>string</td>
                  <td><span class="badge-optional">Optional</span></td>
                  <td>Filter by status: active, inactive, suspended</td>
                </tr>
                <tr>
                  <td><code>search</code></td>
                  <td>string</td>
                  <td><span class="badge-optional">Optional</span></td>
                  <td>Search by client_id, client_name, or redirect_uri</td>
                </tr>
              </tbody>
            </table>

            <h5>Example Response</h5>
            <div class="code-example">
              <div class="code-content">
                <pre><code class="language-json">{
  "success": true,
  "data": [
    {
      "id": 1,
      "client_id": "myapp_web_2024",
      "client_name": "My Web Application",
      "app_redirect_uri": "https://myapp.com/callback",
      "post_logout_redirect_uri": "https://myapp.com/",
      "user_handler_endpoint": "https://myapp.com/api/sso-handler",
      "api_secret_key": "sk_live_xxxxxxxxxx",
      "status": "active",
      "authentication_mode": "JWT Mode",
      "created_at": "2024-01-15 10:30:00",
      "updated_at": "2024-01-20 15:45:00"
    },
    {
      "id": 2,
      "client_id": "legacy_php_app",
      "client_name": "Legacy PHP Application",
      "app_redirect_uri": "https://legacy.com/callback.php",
      "post_logout_redirect_uri": null,
      "user_handler_endpoint": null,
      "api_secret_key": "sk_live_yyyyyyyyyy",
      "status": "active",
      "authentication_mode": "Legacy Mode",
      "created_at": "2023-12-01 08:00:00",
      "updated_at": "2023-12-01 08:00:00"
    }
  ],
  "count": 2
}</code></pre>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Dashboard Auto-Refresh</h3>
        <p>The admin dashboard automatically refreshes statistics every 30 seconds:</p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// Auto-refresh implementation in dashboard.js
let refreshInterval;

function startAutoRefresh() {
  // Initial load
  loadStatistics();
  
  // Set interval for 30 seconds
  refreshInterval = setInterval(() => {
    loadStatistics();
    console.log('Dashboard statistics refreshed');
  }, 30000);
}

function loadStatistics() {
  fetch('/admin/api/stats')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        updateDashboardCards(data.data);
      }
    })
    .catch(err => console.error('Failed to load stats:', err));
}

function updateDashboardCards(stats) {
  document.getElementById('total-clients').textContent = stats.total_clients;
  document.getElementById('active-clients').textContent = stats.active_clients;
  document.getElementById('requests-today').textContent = stats.total_requests_today;
  document.getElementById('inactive-clients').textContent = stats.inactive_clients;
  document.getElementById('success-rate').textContent = stats.success_rate.toFixed(1) + '%';
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', startAutoRefresh);</code></pre>
          </div>
        </div>

        <h3 class="mt-4">Statistics Calculation</h3>
        <p>How the statistics are calculated from the database:</p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-sql">-- Total clients
SELECT COUNT(*) as total_clients FROM clients;

-- Active clients
SELECT COUNT(*) as active_clients 
FROM clients 
WHERE status = 'active';

-- Inactive clients
SELECT COUNT(*) as inactive_clients 
FROM clients 
WHERE status = 'inactive';

-- Suspended clients
SELECT COUNT(*) as suspended_clients 
FROM clients 
WHERE status = 'suspended';

-- Total requests today
SELECT COUNT(*) as total_requests_today 
FROM audit_logs 
WHERE DATE(created_at) = CURDATE();

-- Total requests (all time)
SELECT COUNT(*) as total_requests 
FROM audit_logs;

-- Success rate calculation
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN action IN ('auth_success', 'oidc_auth_success') THEN 1 ELSE 0 END) as success,
  (SUM(CASE WHEN action IN ('auth_success', 'oidc_auth_success') THEN 1 ELSE 0 END) / COUNT(*)) * 100 as success_rate
FROM audit_logs 
WHERE action IN ('auth_success', 'auth_failed', 'oidc_auth_success', 'oidc_auth_failed');

-- Top client activities (last 30 days)
SELECT 
  c.client_id,
  c.client_name,
  COUNT(*) as total_requests,
  SUM(CASE WHEN a.action IN ('auth_success', 'oidc_auth_success') THEN 1 ELSE 0 END) as success_count,
  SUM(CASE WHEN a.action IN ('auth_failed', 'oidc_auth_failed') THEN 1 ELSE 0 END) as failed_count
FROM audit_logs a
JOIN clients c ON a.client_id = c.client_id
WHERE a.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY c.client_id, c.client_name
ORDER BY total_requests DESC
LIMIT 5;

-- System usage trend (last 7 days)
SELECT 
  DATE(created_at) as date,
  COUNT(*) as requests,
  SUM(CASE WHEN action IN ('auth_success', 'oidc_auth_success') THEN 1 ELSE 0 END) as success,
  SUM(CASE WHEN action IN ('auth_failed', 'oidc_auth_failed') THEN 1 ELSE 0 END) as failed
FROM audit_logs
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at)
ORDER BY date ASC;</code></pre>
          </div>
        </div>

        <div class="alert alert-info mt-4">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Note:</strong> All request counting and statistics use the <code>audit_logs</code> table. The system tracks authentication events with actions: <code>auth_success</code>, <code>auth_failed</code>, <code>oidc_auth_success</code>, and <code>oidc_auth_failed</code>.
        </div>

        <h3 class="mt-4">Dashboard Cards Color Coding</h3>
        <p>The dashboard uses specific colors for each statistic card:</p>

        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Card</th>
              <th>Color</th>
              <th>Hex Code</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Clients</td>
              <td><span class="badge" style="background-color: #3498DB; color: white;">Blue</span></td>
              <td><code>#3498DB</code></td>
              <td>Neutral/informational</td>
            </tr>
            <tr>
              <td>Active Clients</td>
              <td><span class="badge" style="background-color: #2ECC71; color: white;">Green</span></td>
              <td><code>#2ECC71</code></td>
              <td>Positive/healthy status</td>
            </tr>
            <tr>
              <td>Requests Today</td>
              <td><span class="badge" style="background-color: #E67E22; color: white;">Orange</span></td>
              <td><code>#E67E22</code></td>
              <td>Activity indicator</td>
            </tr>
            <tr>
              <td>Inactive Clients</td>
              <td><span class="badge" style="background-color: #34495E; color: white;">Dark Gray</span></td>
              <td><code>#34495E</code></td>
              <td>Neutral/disabled</td>
            </tr>
            <tr>
              <td>Suspended Clients</td>
              <td><span class="badge" style="background-color: #E74C3C; color: white;">Red</span></td>
              <td><code>#E74C3C</code></td>
              <td>Warning/critical</td>
            </tr>
          </tbody>
        </table>

        <h3 class="mt-4">Performance Considerations</h3>
        <div class="alert alert-warning">
          <h6><i class="fas fa-bolt me-2"></i>Optimization Tips</h6>
          <ul class="mb-0">
            <li><strong>Database Indexing:</strong> Add indexes on <code>status</code> and <code>created_at</code> columns for faster queries</li>
            <li><strong>Caching:</strong> Consider caching statistics for 5-10 seconds to reduce database load</li>
            <li><strong>Pagination:</strong> For large client lists (1000+), implement pagination</li>
            <li><strong>Query Optimization:</strong> Use a single query with CASE statements instead of multiple queries</li>
          </ul>
        </div>

        <h3 class="mt-4">Example: Optimized Statistics Query</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-sql">-- Single optimized query to get all client statistics
SELECT 
  COUNT(*) as total_clients,
  SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_clients,
  SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_clients,
  SUM(CASE WHEN status = 'suspended' THEN 1 ELSE 0 END) as suspended_clients
FROM clients;

-- Note: In the actual implementation (DashboardController.php),
-- statistics are calculated using separate methods for better code organization:
-- - getTotalClients()
-- - getActiveClients()
-- - getInactiveClients()
-- - getSuspendedClients()
-- - getRequestsToday()
-- - getTotalRequests()
-- - getSuccessRate()
-- - getTopClientActivities()
-- - getSystemUsageTrend()</code></pre>
          </div>
        </div>

        <div class="alert alert-success mt-4">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Pro Tip:</strong> Monitor the dashboard's performance using browser DevTools Network tab. The statistics endpoint should respond in under 100ms for optimal user experience.
        </div>
      </div>

      <div id="backup-restore" class="section-content">
        <h1>Backup & Restore</h1>
        <p class="lead">Data backup and recovery procedures</p>

        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Important:</strong> Regular backups are essential for disaster recovery and preventing data loss. Implement automated backups for production environments.
        </div>

        <h3>What to Backup</h3>
        <p>SSO-Authen V.3 requires backing up both database and configuration files:</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-database me-2"></i>Database</h5>
              </div>
              <div class="card-body">
                <p><strong>Tables to backup:</strong></p>
                <ul>
                  <li><code>clients</code> - Client applications</li>
                  <li><code>jwt_secret_history</code> - JWT secret audit trail</li>
                  <li><code>audit_logs</code> - Authentication & audit logs (optional)</li>
                </ul>
                <p class="mb-0"><strong>Database:</strong> <code>sso_authen</code></p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-file-code me-2"></i>Configuration Files</h5>
              </div>
              <div class="card-body">
                <p><strong>Files to backup:</strong></p>
                <ul>
                  <li><code>config/config.php</code> - Main configuration</li>
                  <li><code>.env</code> - Environment variables (if used)</li>
                  <li><code>config/database.php</code> - Database config</li>
                </ul>
                <p class="mb-0"><strong>Contains:</strong> JWT_SECRET, DB credentials, OIDC settings</p>
              </div>
            </div>
          </div>
        </div>

        <h3 class="mt-4">Manual Backup (Database)</h3>
        
        <h4>Using mysqldump (Recommended)</h4>
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('backup-mysqldump')">
              Full Backup
            </button>
            <button class="code-tab" onclick="showCodeTab('backup-clients-only')">
              Clients Only
            </button>
          </div>
          <div class="code-content">
            <div id="backup-mysqldump" class="code-block active">
              <pre><code class="language-bash"># Full database backup
mysqldump -u root -p sso_authen > backup_sso_authen_$(date +%Y%m%d_%H%M%S).sql

# With compression
mysqldump -u root -p sso_authen | gzip > backup_sso_authen_$(date +%Y%m%d_%H%M%S).sql.gz</code></pre>
            </div>
            <div id="backup-clients-only" class="code-block">
              <pre><code class="language-bash"># Backup only clients table
mysqldump -u root -p sso_authen clients > backup_clients_$(date +%Y%m%d_%H%M%S).sql

# Backup specific tables
mysqldump -u root -p sso_authen clients jwt_secret_history > backup_$(date +%Y%m%d_%H%M%S).sql</code></pre>
            </div>
          </div>
        </div>

        <h4 class="mt-3">Using PHP Admin Panel</h4>
        <p>The admin panel includes a backup feature (if implemented):</p>
        <ol>
          <li>Go to <strong>Backup & Restore</strong> page in admin panel</li>
          <li>Click <strong>"Create Backup"</strong> button</li>
          <li>Select tables to backup (clients, jwt_secret_history, etc.)</li>
          <li>Click <strong>"Download Backup"</strong></li>
          <li>Backup file will be downloaded as <code>backup_YYYYMMDD_HHMMSS.sql</code></li>
        </ol>

        <h3 class="mt-4">Automated Backup</h3>
        
        <h4>Using Cron Job (Linux)</h4>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># Create backup script
cat > /usr/local/bin/backup-sso-authen.sh << 'EOF'
#!/bin/bash

# Configuration
DB_USER="root"
DB_PASS="your_password"
DB_NAME="sso_authen"
BACKUP_DIR="/var/backups/sso-authen"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_$DATE.sql.gz"

# Create backup directory if not exists
mkdir -p $BACKUP_DIR

# Create backup
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_FILE

# Delete backups older than 30 days
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +30 -delete

echo "Backup completed: $BACKUP_FILE"
EOF

# Make executable
chmod +x /usr/local/bin/backup-sso-authen.sh

# Add to crontab (daily at 2 AM)
crontab -e
# Add this line:
0 2 * * * /usr/local/bin/backup-sso-authen.sh >> /var/log/sso-backup.log 2>&1</code></pre>
          </div>
        </div>

        <h4 class="mt-3">Using Windows Task Scheduler</h4>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-batch">@echo off
REM backup-sso-authen.bat

SET DB_USER=root
SET DB_PASS=your_password
SET DB_NAME=sso_authen
SET BACKUP_DIR=C:\backups\sso-authen
SET DATE=%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%%time:~6,2%
SET DATE=%DATE: =0%

REM Create backup directory
if not exist "%BACKUP_DIR%" mkdir "%BACKUP_DIR%"

REM Create backup
"C:\laragon\bin\mysql\mysql-8.0.30\bin\mysqldump.exe" -u %DB_USER% -p%DB_PASS% %DB_NAME% > "%BACKUP_DIR%\backup_%DATE%.sql"

echo Backup completed: %BACKUP_DIR%\backup_%DATE%.sql</code></pre>
          </div>
        </div>

        <h3 class="mt-4">Configuration Backup</h3>
        
        <h4>Manual Method</h4>
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('backup-config-linux')">
              Linux/Mac
            </button>
            <button class="code-tab" onclick="showCodeTab('backup-config-windows')">
              Windows
            </button>
          </div>
          <div class="code-content">
            <div id="backup-config-linux" class="code-block active">
              <pre><code class="language-bash"># Backup config directory
tar -czf config_backup_$(date +%Y%m%d_%H%M%S).tar.gz config/

# Backup specific files
cp config/config.php config/config.php.backup.$(date +%Y%m%d_%H%M%S)</code></pre>
            </div>
            <div id="backup-config-windows" class="code-block">
              <pre><code class="language-batch">REM Backup config directory
xcopy config config_backup_%date:~-4,4%%date:~-10,2%%date:~-7,2% /E /I

REM Backup specific file
copy config\config.php config\config.php.backup.%date:~-4,4%%date:~-10,2%%date:~-7,2%</code></pre>
            </div>
          </div>
        </div>

        <h4 class="mt-3">Automatic Config Backup</h4>
        <p>SSO-Authen automatically creates config backups when:</p>
        <ul>
          <li>JWT secret key is updated (via admin panel)</li>
          <li>Critical configuration changes are made</li>
        </ul>
        <p>Backups are stored in: <code>config/backups/</code></p>

        <h3 class="mt-4">Restore from Backup</h3>
        
        <h4>Database Restore</h4>
        <div class="code-example">
          <div class="code-tabs">
            <button class="code-tab active" onclick="showCodeTab('restore-sql')">
              .sql File
            </button>
            <button class="code-tab" onclick="showCodeTab('restore-gz')">
              .sql.gz File
            </button>
          </div>
          <div class="code-content">
            <div id="restore-sql" class="code-block active">
              <pre><code class="language-bash"># Restore from .sql file
mysql -u root -p sso_authen < backup_sso_authen_20240120_140000.sql

# Or using specific user
mysql -u sso_user -p sso_authen < backup_sso_authen_20240120_140000.sql</code></pre>
            </div>
            <div id="restore-gz" class="code-block">
              <pre><code class="language-bash"># Restore from compressed .sql.gz file
gunzip < backup_sso_authen_20240120_140000.sql.gz | mysql -u root -p sso_authen

# Or decompress first, then restore
gunzip backup_sso_authen_20240120_140000.sql.gz
mysql -u root -p sso_authen < backup_sso_authen_20240120_140000.sql</code></pre>
            </div>
          </div>
        </div>

        <div class="alert alert-danger mt-3">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> Restoring a backup will overwrite existing data! Always create a backup of current data before restoring.
        </div>

        <h4 class="mt-3">Configuration Restore</h4>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># Restore config.php from backup
cp config/config.php.backup.20240120_140000 config/config.php

# Or restore entire config directory
tar -xzf config_backup_20240120_140000.tar.gz</code></pre>
          </div>
        </div>

        <h3 class="mt-4">Backup Strategy Recommendations</h3>
        
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Production Environment</h5>
          </div>
          <div class="card-body">
            <table class="table table-bordered mb-0">
              <thead>
                <tr>
                  <th>Backup Type</th>
                  <th>Frequency</th>
                  <th>Retention</th>
                  <th>Method</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Full Database</strong></td>
                  <td>Daily (2 AM)</td>
                  <td>30 days</td>
                  <td>Automated cron job</td>
                </tr>
                <tr>
                  <td><strong>Config Files</strong></td>
                  <td>Before any change</td>
                  <td>90 days</td>
                  <td>Automatic + Git</td>
                </tr>
                <tr>
                  <td><strong>Full System</strong></td>
                  <td>Weekly</td>
                  <td>12 weeks</td>
                  <td>Complete snapshot</td>
                </tr>
                <tr>
                  <td><strong>Off-site Backup</strong></td>
                  <td>Weekly</td>
                  <td>6 months</td>
                  <td>Cloud storage</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <h3 class="mt-4">Backup Verification</h3>
        <p>Always verify backups can be restored successfully:</p>

        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash">#!/bin/bash
# Backup verification script

BACKUP_FILE="backup_sso_authen_20240120.sql.gz"
TEST_DB="sso_authen_test"

# Create test database
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS $TEST_DB;"

# Try to restore backup
gunzip < $BACKUP_FILE | mysql -u root -p $TEST_DB

if [ $? -eq 0 ]; then
    echo "âœ“ Backup verification successful"
    
    # Check table count
    TABLE_COUNT=$(mysql -u root -p -s -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='$TEST_DB';")
    echo "âœ“ Tables restored: $TABLE_COUNT"
    
    # Cleanup test database
    mysql -u root -p -e "DROP DATABASE $TEST_DB;"
else
    echo "âœ— Backup verification failed!"
    exit 1
fi</code></pre>
          </div>
        </div>

        <h3 class="mt-4">Disaster Recovery Procedure</h3>
        <p>Step-by-step guide to recover from complete system failure:</p>

        <div class="card">
          <div class="card-body">
            <h5>Recovery Steps</h5>
            <ol>
              <li><strong>Prepare Clean Environment</strong>
                <ul>
                  <li>Install PHP 7.4+ and MySQL 5.7+</li>
                  <li>Install required PHP extensions (pdo, pdo_mysql, json, curl)</li>
                  <li>Configure web server (Apache/Nginx)</li>
                </ul>
              </li>
              <li><strong>Deploy Application Code</strong>
                <ul>
                  <li>Download or clone SSO-Authen V.3 from repository</li>
                  <li>Set correct file permissions</li>
                </ul>
              </li>
              <li><strong>Restore Configuration</strong>
                <ul>
                  <li>Restore <code>config/config.php</code> from backup</li>
                  <li>Restore <code>.env</code> file (if used)</li>
                  <li>Verify JWT_SECRET and database credentials</li>
                </ul>
              </li>
              <li><strong>Restore Database</strong>
                <ul>
                  <li>Create database: <code>CREATE DATABASE sso_authen;</code></li>
                  <li>Restore from latest backup</li>
                  <li>Verify table integrity</li>
                </ul>
              </li>
              <li><strong>Verify System</strong>
                <ul>
                  <li>Check admin panel login</li>
                  <li>Verify client list loads correctly</li>
                  <li>Test authentication with a client app</li>
                </ul>
              </li>
              <li><strong>Monitor and Document</strong>
                <ul>
                  <li>Check error logs</li>
                  <li>Monitor authentication requests</li>
                  <li>Document recovery time and issues</li>
                </ul>
              </li>
            </ol>
          </div>
        </div>

        <h3 class="mt-4">Best Practices</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Do</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Automate daily backups</li>
                  <li>Store backups off-site</li>
                  <li>Test restore procedures regularly</li>
                  <li>Encrypt backup files</li>
                  <li>Document recovery procedures</li>
                  <li>Keep multiple backup generations</li>
                  <li>Monitor backup job success</li>
                  <li>Include config files in backups</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>Don't</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>Don't rely on single backup location</li>
                  <li>Don't skip backup verification</li>
                  <li>Don't store backups in same server</li>
                  <li>Don't ignore backup failures</li>
                  <li>Don't delete old backups immediately</li>
                  <li>Don't backup without testing restore</li>
                  <li>Don't expose backups publicly</li>
                  <li>Don't forget JWT secret in backups</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-success mt-4">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>Pro Tip:</strong> Use the 3-2-1 backup rule: Keep 3 copies of data, on 2 different media types, with 1 copy off-site. This ensures data safety even in worst-case scenarios.
        </div>
      </div>

      <div id="php-example" class="section-content">
        <h1>PHP Client Example</h1>
        <p class="lead">Complete PHP integration example with JWT validation</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Example Location:</strong> See <code>/examples/JWT Mode/php-client/</code> in the repository for a complete working example.
        </div>

        <h3>Project Structure</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">php-client/
â”œâ”€â”€ composer.json           # Dependencies (firebase/php-jwt)
â”œâ”€â”€ app_config.php          # Application configuration
â”œâ”€â”€ index.php              # Home page with login button
â”œâ”€â”€ sso_callback.php       # SSO callback handler
â”œâ”€â”€ userinfo.php           # Protected user page
â”œâ”€â”€ logout.php             # Logout handler
â””â”€â”€ api/
    â””â”€â”€ user-handler.php   # User Handler API endpoint</code></pre>
          </div>
        </div>

        <h3>Step 1: Install Dependencies</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-json">// composer.json
{
  "require": {
    "firebase/php-jwt": "^6.11"
  }
}</code></pre>
          </div>
        </div>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># Install dependencies
composer install</code></pre>
          </div>
        </div>

        <h3>Step 2: Configuration (app_config.php)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-php">&lt;?php
// app_config.php
define('SSO_BASE_URL', 'https://sso.oas.psu.ac.th');
define('CLIENT_ID', 'my_php_app');
define('REDIRECT_URI', 'https://myapp.com/sso_callback.php');
define('JWT_SECRET', 'your_jwt_secret_key'); // Same as SSO-Authen config
define('API_SECRET_KEY', 'your_api_secret_key'); // For User Handler API

// Database configuration
define('DB_HOST', 'localhost');
define('DB_NAME', 'myapp_db');
define('DB_USER', 'myapp_user');
define('DB_PASS', 'myapp_password');
?&gt;</code></pre>
          </div>
        </div>

        <h3>Step 3: Home Page with Login (index.php)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-php">&lt;?php
// index.php
require_once 'app_config.php';
session_start();

// Check if already logged in
if (isset($_SESSION['logged_in']) && $_SESSION['logged_in'] === true) {
    header('Location: userinfo.php');
    exit;
}

// Build SSO login URL
$loginUrl = SSO_BASE_URL . '/public/login.php?' . http_build_query([
    'client_id' => CLIENT_ID,
    'redirect_uri' => REDIRECT_URI
]);
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;My PHP App - Home&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="text-center"&gt;
            &lt;h1&gt;Welcome to My PHP Application&lt;/h1&gt;
            &lt;p class="lead"&gt;Please login to continue&lt;/p&gt;
            &lt;a href="&lt;?= htmlspecialchars($loginUrl) ?&gt;" class="btn btn-primary btn-lg"&gt;
                &lt;i class="fas fa-sign-in-alt me-2"&gt;&lt;/i&gt;Login with SSO
            &lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
          </div>
        </div>

        <h3>Step 4: User Handler API (api/user-handler.php)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-php">&lt;?php
// api/user-handler.php
require_once '../app_config.php';
header('Content-Type: application/json');

// 1. Verify API Secret
$receivedSecret = $_SERVER['HTTP_X_API_SECRET'] ?? '';
if ($receivedSecret !== API_SECRET_KEY) {
    http_response_code(401);
    echo json_encode(['error' => 'Unauthorized']);
    exit;
}

// 2. Get input data
$input = json_decode(file_get_contents('php://input'), true);
if (!$input || !isset($input['normalizedUser'])) {
    http_response_code(400);
    echo json_encode(['error' => 'Invalid request']);
    exit;
}

$normalizedUser = $input['normalizedUser'];
$email = $normalizedUser['email'];
$name = $normalizedUser['name'];

try {
    // 3. Connect to database
    $pdo = new PDO(
        "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME,
        DB_USER,
        DB_PASS,
        [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
    );
    
    // 4. Find or create user
    $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
    $stmt->execute([$email]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$user) {
        // Create new user
        $stmt = $pdo->prepare(
            "INSERT INTO users (email, name, email_verified, created_at) 
             VALUES (?, ?, 1, NOW())"
        );
        $stmt->execute([$email, $name]);
        $userId = $pdo->lastInsertId();
        
        $user = [
            'id' => $userId,
            'email' => $email,
            'name' => $name,
            'role' => 'user'
        ];
    } else {
        // Update existing user
        $stmt = $pdo->prepare(
            "UPDATE users SET name = ?, last_login = NOW() WHERE id = ?"
        );
        $stmt->execute([$name, $user['id']]);
    }
    
    // 5. Assign role based on email domain
    if (str_ends_with($email, '@admin.psu.ac.th')) {
        $user['role'] = 'admin';
    } elseif (str_ends_with($email, '@psu.ac.th')) {
        $user['role'] = 'staff';
    } else {
        $user['role'] = 'user';
    }
    
    // 6. Return user data (will be included in JWT)
    echo json_encode([
        'id' => $user['id'],
        'email' => $user['email'],
        'name' => $user['name'],
        'role' => $user['role']
    ]);
    
} catch (PDOException $e) {
    error_log('User Handler Error: ' . $e->getMessage());
    http_response_code(500);
    echo json_encode(['error' => 'Database error']);
}
?&gt;</code></pre>
          </div>
        </div>

        <h3>Step 5: Callback Handler (sso_callback.php)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-php">&lt;?php
// sso_callback.php
require_once 'vendor/autoload.php';
require_once 'app_config.php';

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

session_start();

try {
    // 1. Get token from query parameter
    $token = $_GET['token'] ?? null;
    if (!$token) {
        throw new Exception('No authentication token received');
    }
    
    // 2. Validate and decode JWT
    $decoded = JWT::decode($token, new Key(JWT_SECRET, 'HS256'));
    $userData = (array) $decoded->data;
    
    // 3. Verify required fields
    if (empty($userData['id']) || empty($userData['email'])) {
        throw new Exception('Invalid user data in token');
    }
    
    // 4. Create session
    session_regenerate_id(true);
    $_SESSION['logged_in'] = true;
    $_SESSION['user'] = $userData;
    $_SESSION['jwt_token'] = $token;
    $_SESSION['login_time'] = time();
    
    // 5. Log successful login
    error_log("User logged in: {$userData['email']} (ID: {$userData['id']})");
    
    // 6. Redirect to protected page
    header('Location: userinfo.php');
    exit;
    
} catch (\Firebase\JWT\ExpiredException $e) {
    // Token expired
    $_SESSION['error'] = 'Your session has expired. Please login again.';
    header('Location: index.php');
    exit;
    
} catch (\Firebase\JWT\SignatureInvalidException $e) {
    // Invalid signature
    error_log('JWT signature validation failed: ' . $e->getMessage());
    $_SESSION['error'] = 'Authentication failed. Please try again.';
    header('Location: index.php');
    exit;
    
} catch (Exception $e) {
    // Other errors
    error_log('Callback error: ' . $e->getMessage());
    $_SESSION['error'] = 'Authentication error: ' . $e->getMessage();
    header('Location: index.php');
    exit;
}
?&gt;</code></pre>
          </div>
        </div>

        <h3>Step 6: Protected Page (userinfo.php)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-php">&lt;?php
// userinfo.php
require_once 'app_config.php';
session_start();

// Check if logged in
if (!isset($_SESSION['logged_in']) || $_SESSION['logged_in'] !== true) {
    header('Location: index.php');
    exit;
}

$user = $_SESSION['user'];
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;User Profile&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h4 class="mb-0"&gt;User Profile&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;table class="table"&gt;
                            &lt;tr&gt;
                                &lt;th&gt;ID:&lt;/th&gt;
                                &lt;td&gt;&lt;?= htmlspecialchars($user['id']) ?&gt;&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Email:&lt;/th&gt;
                                &lt;td&gt;&lt;?= htmlspecialchars($user['email']) ?&gt;&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Name:&lt;/th&gt;
                                &lt;td&gt;&lt;?= htmlspecialchars($user['name']) ?&gt;&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Role:&lt;/th&gt;
                                &lt;td&gt;&lt;span class="badge bg-success"&gt;&lt;?= htmlspecialchars($user['role']) ?&gt;&lt;/span&gt;&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Login Time:&lt;/th&gt;
                                &lt;td&gt;&lt;?= date('Y-m-d H:i:s', $_SESSION['login_time']) ?&gt;&lt;/td&gt;
                            &lt;/tr&gt;
                        &lt;/table&gt;
                        &lt;div class="text-center mt-4"&gt;
                            &lt;a href="logout.php" class="btn btn-danger"&gt;
                                &lt;i class="fas fa-sign-out-alt me-2"&gt;&lt;/i&gt;Logout
                            &lt;/a&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
          </div>
        </div>

        <h3>Step 7: Logout Handler (logout.php)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-php">&lt;?php
// logout.php
require_once 'app_config.php';
session_start();

// Clear application session
session_unset();
session_destroy();

// Clear session cookie
if (isset($_COOKIE[session_name()])) {
    setcookie(session_name(), '', time() - 3600, '/');
}

// Build SSO logout URL
$ssoLogoutUrl = SSO_BASE_URL . '/public/logout.php';
$returnUrl = 'https://myapp.com/'; // Your app homepage

$logoutUrl = $ssoLogoutUrl . '?' . http_build_query([
    'post_logout_redirect_uri' => $returnUrl
]);

// Redirect to SSO logout
header("Location: $logoutUrl");
exit;
?&gt;</code></pre>
          </div>
        </div>

        <h3>Database Schema</h3>
        <p>Create the users table in your application database:</p>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-sql">CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) DEFAULT 'user',
  email_verified TINYINT(1) DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  last_login TIMESTAMP NULL,
  INDEX idx_email (email),
  INDEX idx_role (role)
);</code></pre>
          </div>
        </div>

        <h3>Testing the Integration</h3>
        <ol>
          <li><strong>Setup:</strong> Configure your client in SSO-Authen admin panel</li>
          <li><strong>Database:</strong> Create the users table in your database</li>
          <li><strong>Config:</strong> Update app_config.php with correct values</li>
          <li><strong>Install:</strong> Run <code>composer install</code></li>
          <li><strong>Test:</strong> Visit index.php and click "Login with SSO"</li>
          <li><strong>Verify:</strong> Check that you're redirected to userinfo.php after authentication</li>
        </ol>

        <div class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Success!</strong> You now have a fully functional PHP application integrated with SSO-Authen V.3.
        </div>
      </div>

      <div id="javascript-example" class="section-content">
        <h1>JavaScript Client Example</h1>
        <p class="lead">Complete Vanilla JavaScript integration with Node.js backend</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Example Location:</strong> See <code>/examples/JWT Mode/js-client/</code> in the repository for a complete working example.
        </div>

        <h3>Project Structure</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">js-client/
â”œâ”€â”€ package.json            # Dependencies
â”œâ”€â”€ api/
â”‚   â””â”€â”€ server.js          # Express backend with User Handler
â””â”€â”€ public/
    â”œâ”€â”€ index.html         # Home page with login
    â”œâ”€â”€ callback.html      # SSO callback handler
    â”œâ”€â”€ userinfo.html      # Protected user page
    â””â”€â”€ app.js            # Frontend JavaScript</code></pre>
          </div>
        </div>

        <h3>Step 1: Install Dependencies</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-json">// package.json
{
  "name": "sso-js-client",
  "version": "1.0.0",
  "scripts": {
    "start": "node api/server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "mysql2": "^3.6.0"
  }
}</code></pre>
          </div>
        </div>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># Install dependencies
npm install</code></pre>
          </div>
        </div>

        <h3>Step 2: Backend Server (api/server.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// api/server.js
const express = require('express');
const cors = require('cors');
const jwt = require('jsonwebtoken');
const mysql = require('mysql2/promise');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// Database connection
const dbConfig = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASS || '',
  database: process.env.DB_NAME || 'myapp_db'
};

// User Handler API Endpoint
app.post('/api/sso-user-handler', async (req, res) => {
  try {
    // 1. Verify API Secret
    const receivedSecret = req.headers['x-api-secret'];
    if (receivedSecret !== process.env.API_SECRET_KEY) {
      return res.status(401).json({ error: 'Unauthorized' });
    }
    
    // 2. Get normalized user data
    const { normalizedUser } = req.body;
    if (!normalizedUser || !normalizedUser.email) {
      return res.status(400).json({ error: 'Invalid request' });
    }
    
    const email = normalizedUser.email;
    const name = normalizedUser.name;
    
    // 3. Connect to database
    const connection = await mysql.createConnection(dbConfig);
    
    try {
      // 4. Find or create user
      const [rows] = await connection.execute(
        'SELECT * FROM users WHERE email = ?',
        [email]
      );
      
      let user;
      if (rows.length === 0) {
        // Create new user
        const [result] = await connection.execute(
          'INSERT INTO users (email, name, email_verified, created_at) VALUES (?, ?, 1, NOW())',
          [email, name]
        );
        
        user = {
          id: result.insertId,
          email: email,
          name: name,
          role: 'user'
        };
      } else {
        // Update existing user
        user = rows[0];
        await connection.execute(
          'UPDATE users SET name = ?, last_login = NOW() WHERE id = ?',
          [name, user.id]
        );
      }
      
      // 5. Assign role based on email domain
      if (email.endsWith('@admin.psu.ac.th')) {
        user.role = 'admin';
      } else if (email.endsWith('@psu.ac.th')) {
        user.role = 'staff';
      } else {
        user.role = 'user';
      }
      
      // 6. Return user data (will be included in JWT)
      res.json({
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role
      });
      
    } finally {
      await connection.end();
    }
    
  } catch (error) {
    console.error('User handler error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Validate JWT endpoint (optional - for frontend)
app.post('/api/validate-token', (req, res) => {
  try {
    const { token } = req.body;
    if (!token) {
      return res.status(400).json({ valid: false, error: 'No token provided' });
    }
    
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    res.json({ valid: true, data: decoded.data });
  } catch (err) {
    if (err.name === 'TokenExpiredError') {
      res.json({ valid: false, error: 'Token expired' });
    } else {
      res.json({ valid: false, error: 'Invalid token' });
    }
  }
});

app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});</code></pre>
          </div>
        </div>

        <h3>Step 3: Environment Configuration (.env)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># .env
PORT=3000

# SSO Configuration
SSO_BASE_URL=https://sso.oas.psu.ac.th
CLIENT_ID=my_js_app
REDIRECT_URI=http://localhost:3000/callback.html
JWT_SECRET=your_jwt_secret_key
API_SECRET_KEY=your_api_secret_key

# Database Configuration
DB_HOST=localhost
DB_USER=root
DB_PASS=
DB_NAME=myapp_db</code></pre>
          </div>
        </div>

        <h3>Step 4: Home Page (public/index.html)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;My JS App - Home&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="text-center"&gt;
            &lt;h1&gt;Welcome to My JavaScript Application&lt;/h1&gt;
            &lt;p class="lead"&gt;Please login to continue&lt;/p&gt;
            &lt;button id="loginBtn" class="btn btn-primary btn-lg"&gt;
                &lt;i class="fas fa-sign-in-alt me-2"&gt;&lt;/i&gt;Login with SSO
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
        // Configuration
        const SSO_BASE_URL = 'https://sso.oas.psu.ac.th';
        const CLIENT_ID = 'my_js_app';
        const REDIRECT_URI = window.location.origin + '/callback.html';

        // Check if already logged in
        const token = localStorage.getItem('jwt_token');
        if (token) {
            window.location.href = '/userinfo.html';
        }

        // Login button handler
        document.getElementById('loginBtn').addEventListener('click', () => {
            const loginUrl = `${SSO_BASE_URL}/public/login.php?` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            
            window.location.href = loginUrl;
        });
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
          </div>
        </div>

        <h3>Step 5: Callback Handler (public/callback.html)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;Processing Login...&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="text-center"&gt;
            &lt;div class="spinner-border text-primary" role="status"&gt;
                &lt;span class="visually-hidden"&gt;Loading...&lt;/span&gt;
            &lt;/div&gt;
            &lt;p class="mt-3"&gt;Processing authentication...&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            alert('No authentication token received');
            window.location.href = '/';
        } else {
            // Validate token with backend
            fetch('/api/validate-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token })
            })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    // Store token and user data
                    localStorage.setItem('jwt_token', token);
                    localStorage.setItem('user', JSON.stringify(data.data));
                    
                    // Redirect to user info page
                    window.location.href = '/userinfo.html';
                } else {
                    alert('Token validation failed: ' + data.error);
                    window.location.href = '/';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Authentication failed');
                window.location.href = '/';
            });
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
          </div>
        </div>

        <h3>Step 6: User Info Page (public/userinfo.html)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;User Profile&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h4 class="mb-0"&gt;User Profile&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;table class="table"&gt;
                            &lt;tr&gt;
                                &lt;th&gt;ID:&lt;/th&gt;
                                &lt;td id="userId"&gt;-&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Email:&lt;/th&gt;
                                &lt;td id="userEmail"&gt;-&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Name:&lt;/th&gt;
                                &lt;td id="userName"&gt;-&lt;/td&gt;
                            &lt;/tr&gt;
                            &lt;tr&gt;
                                &lt;th&gt;Role:&lt;/th&gt;
                                &lt;td&gt;&lt;span id="userRole" class="badge bg-success"&gt;-&lt;/span&gt;&lt;/td&gt;
                            &lt;/tr&gt;
                        &lt;/table&gt;
                        &lt;div class="text-center mt-4"&gt;
                            &lt;button id="logoutBtn" class="btn btn-danger"&gt;
                                &lt;i class="fas fa-sign-out-alt me-2"&gt;&lt;/i&gt;Logout
                            &lt;/button&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
        const SSO_BASE_URL = 'https://sso.oas.psu.ac.th';

        // Check if logged in
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
            window.location.href = '/';
        } else {
            // Display user information
            document.getElementById('userId').textContent = user.id;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userRole').textContent = user.role;
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            // Clear local storage
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user');
            
            // Redirect to SSO logout
            const returnUrl = window.location.origin;
            const logoutUrl = `${SSO_BASE_URL}/public/logout.php?` +
                `post_logout_redirect_uri=${encodeURIComponent(returnUrl)}`;
            
            window.location.href = logoutUrl;
        });
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
          </div>
        </div>

        <h3>Running the Application</h3>
        <ol>
          <li><strong>Setup:</strong> Configure your client in SSO-Authen admin panel</li>
          <li><strong>Database:</strong> Create the users table (same schema as PHP example)</li>
          <li><strong>Config:</strong> Update .env file with correct values</li>
          <li><strong>Install:</strong> Run <code>npm install</code></li>
          <li><strong>Start:</strong> Run <code>npm start</code></li>
          <li><strong>Test:</strong> Visit <code>http://localhost:3000</code></li>
        </ol>

        <div class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Success!</strong> Your JavaScript application is now integrated with SSO-Authen V.3.
        </div>
      </div>

      <div id="react-example" class="section-content">
        <h1>React Client Example</h1>
        <p class="lead">Complete React integration with Context API and React Router</p>

        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Note:</strong> This example uses React 18+ with functional components, hooks, and React Router v6.
        </div>

        <h3>Project Setup</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># Create React app
npx create-react-app sso-react-client
cd sso-react-client

# Install dependencies
npm install react-router-dom jwt-decode axios</code></pre>
          </div>
        </div>

        <h3>Project Structure</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-text">src/
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ AuthContext.js      # Authentication context
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ PrivateRoute.js     # Protected route wrapper
â”‚   â””â”€â”€ Navbar.js          # Navigation bar
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Home.js            # Home/Login page
â”‚   â”œâ”€â”€ Callback.js        # SSO callback handler
â”‚   â”œâ”€â”€ Dashboard.js       # Protected dashboard
â”‚   â””â”€â”€ Profile.js         # User profile page
â”œâ”€â”€ config.js              # Configuration
â”œâ”€â”€ App.js                # Main app component
â””â”€â”€ index.js              # Entry point</code></pre>
          </div>
        </div>

        <h3>Step 1: Configuration (src/config.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/config.js
export const config = {
  SSO_BASE_URL: 'https://sso.oas.psu.ac.th',
  CLIENT_ID: 'my_react_app',
  REDIRECT_URI: `${window.location.origin}/callback`,
  POST_LOGOUT_REDIRECT_URI: window.location.origin,
  JWT_SECRET: process.env.REACT_APP_JWT_SECRET,
  API_BASE_URL: process.env.REACT_APP_API_URL || 'http://localhost:3000'
};

export default config;</code></pre>
          </div>
        </div>

        <h3>Step 2: Auth Context (src/contexts/AuthContext.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/contexts/AuthContext.js
import React, { createContext, useState, useContext, useEffect } from 'react';
import jwtDecode from 'jwt-decode';
import config from '../config';

const AuthContext = createContext();

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [token, setToken] = useState(null);

  useEffect(() => {
    // Check for existing token on mount
    const storedToken = localStorage.getItem('jwt_token');
    if (storedToken) {
      try {
        const decoded = jwtDecode(storedToken);
        
        // Check if token is expired
        if (decoded.exp * 1000 < Date.now()) {
          logout();
        } else {
          setToken(storedToken);
          setUser(decoded.data);
        }
      } catch (err) {
        console.error('Invalid token:', err);
        logout();
      }
    }
    setLoading(false);
  }, []);

  const login = (jwtToken) => {
    try {
      const decoded = jwtDecode(jwtToken);
      localStorage.setItem('jwt_token', jwtToken);
      localStorage.setItem('user', JSON.stringify(decoded.data));
      setToken(jwtToken);
      setUser(decoded.data);
      return true;
    } catch (err) {
      console.error('Login failed:', err);
      return false;
    }
  };

  const logout = () => {
    localStorage.removeItem('jwt_token');
    localStorage.removeItem('user');
    setToken(null);
    setUser(null);
    
    // Redirect to SSO logout
    const logoutUrl = `${config.SSO_BASE_URL}/public/logout.php?` +
      `post_logout_redirect_uri=${encodeURIComponent(config.POST_LOGOUT_REDIRECT_URI)}`;
    window.location.href = logoutUrl;
  };

  const redirectToLogin = () => {
    const loginUrl = `${config.SSO_BASE_URL}/public/login.php?` +
      `client_id=${config.CLIENT_ID}&` +
      `redirect_uri=${encodeURIComponent(config.REDIRECT_URI)}`;
    window.location.href = loginUrl;
  };

  const value = {
    user,
    token,
    isAuthenticated: !!user,
    loading,
    login,
    logout,
    redirectToLogin
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};</code></pre>
          </div>
        </div>

        <h3>Step 3: Private Route Component (src/components/PrivateRoute.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/components/PrivateRoute.js
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

const PrivateRoute = ({ children }) => {
  const { isAuthenticated, loading } = useAuth();

  if (loading) {
    return (
      <div className="d-flex justify-content-center align-items-center" style={{ height: '100vh' }}>
        <div className="spinner-border text-primary" role="status">
          <span className="visually-hidden">Loading...</span>
        </div>
      </div>
    );
  }

  return isAuthenticated ? children : <Navigate to="/" replace />;
};

export default PrivateRoute;</code></pre>
          </div>
        </div>

        <h3>Step 4: Home Page (src/pages/Home.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/pages/Home.js
import React, { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

const Home = () => {
  const { isAuthenticated, redirectToLogin } = useAuth();
  const navigate = useNavigate();

  useEffect(() => {
    // Redirect to dashboard if already logged in
    if (isAuthenticated) {
      navigate('/dashboard');
    }
  }, [isAuthenticated, navigate]);

  return (
    <div className="container mt-5">
      <div className="row justify-content-center">
        <div className="col-md-6 text-center">
          <div className="card">
            <div className="card-body p-5">
              <h1 className="mb-4">Welcome to My React App</h1>
              <p className="lead mb-4">Please login to continue</p>
              <button 
                className="btn btn-primary btn-lg"
                onClick={redirectToLogin}
              >
                <i className="fas fa-sign-in-alt me-2"></i>
                Login with SSO
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Home;</code></pre>
          </div>
        </div>

        <h3>Step 5: Callback Page (src/pages/Callback.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/pages/Callback.js
import React, { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

const Callback = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { login } = useAuth();
  const [error, setError] = useState(null);

  useEffect(() => {
    const token = searchParams.get('token');

    if (!token) {
      setError('No authentication token received');
      setTimeout(() => navigate('/'), 3000);
      return;
    }

    // Attempt to login with token
    const success = login(token);
    if (success) {
      navigate('/dashboard');
    } else {
      setError('Token validation failed');
      setTimeout(() => navigate('/'), 3000);
    }
  }, [searchParams, login, navigate]);

  return (
    <div className="container mt-5">
      <div className="row justify-content-center">
        <div className="col-md-6 text-center">
          {error ? (
            <div className="alert alert-danger" role="alert">
              <i className="fas fa-exclamation-triangle me-2"></i>
              {error}
            </div>
          ) : (
            <div>
              <div className="spinner-border text-primary mb-3" role="status">
                <span className="visually-hidden">Loading...</span>
              </div>
              <p>Processing authentication...</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default Callback;</code></pre>
          </div>
        </div>

        <h3>Step 6: Dashboard Page (src/pages/Dashboard.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/pages/Dashboard.js
import React from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

const Dashboard = () => {
  const { user } = useAuth();

  return (
    <div className="container mt-5">
      <div className="row">
        <div className="col-md-12">
          <h1>Dashboard</h1>
          <p className="lead">Welcome back, {user?.name}!</p>
          
          <div className="row mt-4">
            <div className="col-md-4">
              <div className="card">
                <div className="card-body">
                  <h5 className="card-title">Profile</h5>
                  <p className="card-text">View and manage your profile information.</p>
                  <Link to="/profile" className="btn btn-primary">View Profile</Link>
                </div>
              </div>
            </div>
            <div className="col-md-4">
              <div className="card">
                <div className="card-body">
                  <h5 className="card-title">Settings</h5>
                  <p className="card-text">Manage your account settings.</p>
                  <button className="btn btn-secondary" disabled>Coming Soon</button>
                </div>
              </div>
            </div>
            <div className="col-md-4">
              <div className="card">
                <div className="card-body">
                  <h5 className="card-title">Help</h5>
                  <p className="card-text">Get help and support.</p>
                  <button className="btn btn-info" disabled>Coming Soon</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;</code></pre>
          </div>
        </div>

        <h3>Step 7: Profile Page (src/pages/Profile.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/pages/Profile.js
import React from 'react';
import { useAuth } from '../contexts/AuthContext';

const Profile = () => {
  const { user, logout } = useAuth();

  return (
    <div className="container mt-5">
      <div className="row justify-content-center">
        <div className="col-md-6">
          <div className="card">
            <div className="card-header bg-primary text-white">
              <h4 className="mb-0">User Profile</h4>
            </div>
            <div className="card-body">
              <table className="table">
                <tbody>
                  <tr>
                    <th>ID:</th>
                    <td>{user?.id}</td>
                  </tr>
                  <tr>
                    <th>Email:</th>
                    <td>{user?.email}</td>
                  </tr>
                  <tr>
                    <th>Name:</th>
                    <td>{user?.name}</td>
                  </tr>
                  <tr>
                    <th>Role:</th>
                    <td>
                      <span className="badge bg-success">{user?.role}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div className="text-center mt-4">
                <button className="btn btn-danger" onClick={logout}>
                  <i className="fas fa-sign-out-alt me-2"></i>
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Profile;</code></pre>
          </div>
        </div>

        <h3>Step 8: Navigation Bar (src/components/Navbar.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/components/Navbar.js
import React from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

const Navbar = () => {
  const { isAuthenticated, user, logout } = useAuth();

  return (
    <nav className="navbar navbar-expand-lg navbar-dark bg-primary">
      <div className="container">
        <Link className="navbar-brand" to="/">
          My React App
        </Link>
        
        {isAuthenticated && (
          <>
            <button 
              className="navbar-toggler" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#navbarNav"
            >
              <span className="navbar-toggler-icon"></span>
            </button>
            <div className="collapse navbar-collapse" id="navbarNav">
              <ul className="navbar-nav ms-auto">
                <li className="nav-item">
                  <Link className="nav-link" to="/dashboard">
                    Dashboard
                  </Link>
                </li>
                <li className="nav-item">
                  <Link className="nav-link" to="/profile">
                    Profile
                  </Link>
                </li>
                <li className="nav-item">
                  <span className="nav-link">
                    {user?.name}
                  </span>
                </li>
                <li className="nav-item">
                  <button className="btn btn-outline-light" onClick={logout}>
                    Logout
                  </button>
                </li>
              </ul>
            </div>
          </>
        )}
      </div>
    </nav>
  );
};

export default Navbar;</code></pre>
          </div>
        </div>

        <h3>Step 9: Main App (src/App.js)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-javascript">// src/App.js
import React from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { AuthProvider } from './contexts/AuthContext';
import PrivateRoute from './components/PrivateRoute';
import Navbar from './components/Navbar';
import Home from './pages/Home';
import Callback from './pages/Callback';
import Dashboard from './pages/Dashboard';
import Profile from './pages/Profile';

function App() {
  return (
    <Router>
      <AuthProvider>
        <Navbar />
        <Routes>
          <Route path="/" element={<Home />} />
          <Route path="/callback" element={<Callback />} />
          <Route
            path="/dashboard"
            element={
              <PrivateRoute>
                <Dashboard />
              </PrivateRoute>
            }
          />
          <Route
            path="/profile"
            element={
              <PrivateRoute>
                <Profile />
              </PrivateRoute>
            }
          />
        </Routes>
      </AuthProvider>
    </Router>
  );
}

export default App;</code></pre>
          </div>
        </div>

        <h3>Step 10: Environment Variables (.env)</h3>
        <div class="code-example">
          <div class="code-content">
            <pre><code class="language-bash"># .env (in root directory)
REACT_APP_JWT_SECRET=your_jwt_secret_key
REACT_APP_API_URL=http://localhost:3000</code></pre>
          </div>
        </div>

        <h3>Running the Application</h3>
        <ol>
          <li><strong>Backend:</strong> Set up the Node.js backend (from JavaScript example) to handle User Handler API</li>
          <li><strong>Install:</strong> Run <code>npm install</code> in React project</li>
          <li><strong>Configure:</strong> Update src/config.js and .env with your values</li>
          <li><strong>Start:</strong> Run <code>npm start</code></li>
          <li><strong>Test:</strong> Visit <code>http://localhost:3001</code></li>
        </ol>

        <div class="alert alert-info mt-4">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Note:</strong> Make sure your backend API (with User Handler endpoint) is running on port 3000, and React app runs on port 3001 (or configure accordingly).
        </div>

        <div class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Success!</strong> Your React application is now fully integrated with SSO-Authen V.3 with context-based authentication.
        </div>
      </div>

      <div id="troubleshooting" class="section-content">
        <h1>Troubleshooting</h1>
        <p class="lead">Common issues and solutions</p>

        <div class="accordion" id="troubleshootingAccordion">
          
          <!-- Issue 1 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#issue1">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                "Unauthorized client ID" error when trying to login
              </button>
            </h2>
            <div id="issue1" class="accordion-collapse collapse show" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>You see an error: "Unauthorized client ID: xxx" when redirecting to SSO login.</p>
                
                <h6>Causes:</h6>
                <ul>
                  <li>Client ID not registered in SSO-Authen database</li>
                  <li>Typo in client_id parameter</li>
                  <li>Client status is inactive or suspended</li>
                </ul>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Verify client_id is registered in Admin Panel â†’ Client Management</li>
                  <li>Check that client status is "active"</li>
                  <li>Ensure client_id in your code matches exactly (case-sensitive)</li>
                  <li>Check SSO-Authen database: <code>SELECT * FROM clients WHERE client_id = 'your_id'</code></li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Issue 2 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue2">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                "Redirect URI does not match" error
              </button>
            </h2>
            <div id="issue2" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>Error message: "Redirect URI does not match registered URI"</p>
                
                <h6>Causes:</h6>
                <ul>
                  <li>redirect_uri parameter doesn't match database value exactly</li>
                  <li>Protocol mismatch (http vs https)</li>
                  <li>Trailing slash difference</li>
                  <li>Port number mismatch</li>
                </ul>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Check registered URI in Admin Panel</li>
                  <li>Ensure exact match including:
                    <ul>
                      <li>Protocol: http:// or https://</li>
                      <li>Domain: example.com (not www.example.com)</li>
                      <li>Port: :3000 if specified</li>
                      <li>Path: /callback (not /callback/)</li>
                    </ul>
                  </li>
                  <li>Use <code>encodeURIComponent()</code> when building login URL</li>
                </ol>
                
                <div class="code-example mt-2">
                  <div class="code-content">
                    <pre><code class="language-javascript">// Correct
const redirectUri = 'https://myapp.com/callback';

// Incorrect (will fail)
const redirectUri = 'https://myapp.com/callback/';  // Extra slash
const redirectUri = 'http://myapp.com/callback';   // Wrong protocol</code></pre>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Issue 3 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue3">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                "Invalid token signature" or JWT validation fails
              </button>
            </h2>
            <div id="issue3" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>JWT validation fails with "SignatureInvalidException" or "Invalid token"</p>
                
                <h6>Causes:</h6>
                <ul>
                  <li>JWT_SECRET mismatch between SSO-Authen and your app</li>
                  <li>JWT_SECRET was changed but not updated in your app</li>
                  <li>Wrong algorithm specified (should be HS256)</li>
                  <li>Token was modified/tampered</li>
                </ul>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Verify JWT_SECRET in your app matches SSO-Authen config.php:
                    <pre><code>// In SSO-Authen config.php
define('JWT_SECRET', 'your_secret_key');

// In your app
const JWT_SECRET = 'your_secret_key'; // Must match exactly</code></pre>
                  </li>
                  <li>Check algorithm is HS256 (HMAC SHA256)</li>
                  <li>Ensure secret has no extra spaces or newlines</li>
                  <li>Use environment variables to manage secrets</li>
                  <li>Test with a fresh token after updating secret</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Issue 4 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue4">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                User Handler API returns 401 Unauthorized
              </button>
            </h2>
            <div id="issue4" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>SSO-Authen cannot call your User Handler API, returns 401 error</p>
                
                <h6>Causes:</h6>
                <ul>
                  <li>X-API-SECRET header mismatch</li>
                  <li>API endpoint not accessible</li>
                  <li>CORS issues</li>
                  <li>SSL/TLS certificate problems</li>
                </ul>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Verify API secret matches in both places:
                    <pre><code>// In Admin Panel (Client config)
api_secret_key: "your_api_secret"

// In your User Handler
if (receivedSecret !== 'your_api_secret') { // Must match }</code></pre>
                  </li>
                  <li>Test endpoint manually:
                    <pre><code>curl -X POST https://yourapp.com/api/user-handler \
  -H "Content-Type: application/json" \
  -H "X-API-Secret: your_api_secret" \
  -d '{"normalizedUser":{"email":"test@test.com","name":"Test"}}'</code></pre>
                  </li>
                  <li>Check server logs for errors</li>
                  <li>Ensure endpoint uses HTTPS in production</li>
                  <li>Verify firewall allows connections from SSO-Authen server</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Issue 5 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue5">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                "Token has expired" error
              </button>
            </h2>
            <div id="issue5" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>User gets "Token has expired" or "ExpiredException"</p>
                
                <h6>Causes:</h6>
                <ul>
                  <li>JWT token expired (default: 2 hours)</li>
                  <li>Token stored too long in localStorage</li>
                  <li>Server time mismatch</li>
                </ul>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Implement token refresh or re-authentication:
                    <pre><code>// Check token expiration before use
const decoded = jwtDecode(token);
if (decoded.exp * 1000 < Date.now()) {
  // Token expired, redirect to login
  redirectToLogin();
}</code></pre>
                  </li>
                  <li>Adjust JWT_EXPIRATION in SSO-Authen config if needed</li>
                  <li>Implement refresh token mechanism</li>
                  <li>Clear expired tokens from storage on app startup</li>
                  <li>Sync server times if using multiple servers</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Issue 6 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue6">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                CORS errors when calling SSO endpoints
              </button>
            </h2>
            <div id="issue6" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>Browser console shows CORS policy errors</p>
                
                <h6>Cause:</h6>
                <p>SSO-Authen endpoints are designed for redirects, not AJAX calls</p>
                
                <h6>Solution:</h6>
                <p><strong>Use window.location.href for SSO endpoints:</strong></p>
                <div class="code-example">
                  <div class="code-content">
                    <pre><code class="language-javascript">// âœ“ Correct - Use redirect
window.location.href = ssoLoginUrl;

// âœ— Wrong - Don't use fetch/axios for login
fetch(ssoLoginUrl); // Will cause CORS error</code></pre>
                  </div>
                </div>
                <p>SSO flow uses browser redirects, not API calls. Only your User Handler API needs CORS configuration.</p>
              </div>
            </div>
          </div>

          <!-- Issue 7 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue7">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                Database connection errors
              </button>
            </h2>
            <div id="issue7" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>SSO-Authen or Admin Panel shows database connection errors</p>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Verify database credentials in config.php:
                    <pre><code>define('DB_HOST', 'localhost');
define('DB_NAME', 'sso_authen');
define('DB_USER', 'your_user');
define('DB_PASS', 'your_password');</code></pre>
                  </li>
                  <li>Check database exists: <code>SHOW DATABASES LIKE 'sso_authen';</code></li>
                  <li>Verify MySQL is running: <code>systemctl status mysql</code></li>
                  <li>Test connection:
                    <pre><code>mysql -u your_user -p -h localhost sso_authen</code></pre>
                  </li>
                  <li>Check database user has correct permissions:
                    <pre><code>GRANT ALL PRIVILEGES ON sso_authen.* TO 'your_user'@'localhost';
FLUSH PRIVILEGES;</code></pre>
                  </li>
                </ol>
              </div>
            </div>
          </div>

          <!-- Issue 8 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue8">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                "Class not found" or autoload errors
              </button>
            </h2>
            <div id="issue8" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
              <div class="accordion-body">
                <h6>Problem:</h6>
                <p>PHP errors like "Class 'Firebase\JWT\JWT' not found"</p>
                
                <h6>Cause:</h6>
                <p>Composer dependencies not installed</p>
                
                <h6>Solutions:</h6>
                <ol>
                  <li>Install composer dependencies:
                    <pre><code>cd /path/to/sso-authen-3
composer install</code></pre>
                  </li>
                  <li>Verify vendor/autoload.php exists</li>
                  <li>Check composer.json has correct dependencies</li>
                  <li>Try clearing composer cache:
                    <pre><code>composer clear-cache
composer install</code></pre>
                  </li>
                  <li>Ensure require statement is correct:
                    <pre><code>require_once __DIR__ . '/vendor/autoload.php';</code></pre>
                  </li>
                </ol>
              </div>
            </div>
          </div>

        </div>

        <h3 class="mt-5">Debugging Tips</h3>
        <div class="row">
          <div class="col-md-6">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-bug me-2"></i>Enable Debug Mode</h6>
              </div>
              <div class="card-body">
                <p>Add to config.php:</p>
                <pre><code class="language-php">// Enable error reporting
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Enable logging
ini_set('log_errors', 1);
ini_set('error_log', '/path/to/error.log');</code></pre>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-warning">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>Check Logs</h6>
              </div>
              <div class="card-body">
                <p>Common log locations:</p>
                <ul class="small mb-0">
                  <li><strong>PHP errors:</strong> /var/log/php/error.log</li>
                  <li><strong>Apache:</strong> /var/log/apache2/error.log</li>
                  <li><strong>Nginx:</strong> /var/log/nginx/error.log</li>
                  <li><strong>Browser:</strong> DevTools Console (F12)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-4">
          <i class="fas fa-life-ring me-2"></i>
          <strong>Still having issues?</strong> Check the FAQ section below or contact your system administrator for help.
        </div>
      </div>

      <div id="faq" class="section-content">
        <h1>Frequently Asked Questions (FAQ)</h1>
        <p class="lead">Common questions about SSO-Authen V.3</p>

        <div class="accordion" id="faqAccordion">
          
          <!-- FAQ 1 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                What is SSO-Authen V.3?
              </button>
            </h2>
            <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p>SSO-Authen V.3 is a centralized authentication gateway that implements the OpenID Connect (OIDC) standard. It acts as a bridge between your applications and OIDC providers (like PSU SSO, Google, Microsoft), providing a unified authentication interface.</p>
                <p><strong>Key features:</strong></p>
                <ul>
                  <li>Centralized authentication for multiple applications</li>
                  <li>JWT-based stateless authentication</li>
                  <li>Support for any technology stack (PHP, Node.js, React, etc.)</li>
                  <li>Flexible role assignment through User Handler API</li>
                  <li>Admin panel for managing clients</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- FAQ 2 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                Is SSO-Authen an OIDC Provider?
              </button>
            </h2>
            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>No.</strong> SSO-Authen is an <strong>OIDC Client/Gateway</strong>, not an OIDC Provider.</p>
                <p>It connects to external OIDC providers (like PSU SSO, Google) and provides a simplified authentication interface to your applications. Think of it as a middleware between your apps and the actual identity providers.</p>
              </div>
            </div>
          </div>

          <!-- FAQ 3 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                What's the difference between JWT Mode and Legacy Mode?
              </button>
            </h2>
            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Feature</th>
                      <th>JWT Mode</th>
                      <th>Legacy Mode</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Technology</strong></td>
                      <td>Any (PHP, Node.js, React, etc.)</td>
                      <td>PHP only</td>
                    </tr>
                    <tr>
                      <td><strong>Authentication</strong></td>
                      <td>JWT token returned to app</td>
                      <td>Direct session creation</td>
                    </tr>
                    <tr>
                      <td><strong>Domain Requirement</strong></td>
                      <td>Can be on different domain</td>
                      <td>Must be on same domain</td>
                    </tr>
                    <tr>
                      <td><strong>User Handler API</strong></td>
                      <td>Required</td>
                      <td>Not required</td>
                    </tr>
                    <tr>
                      <td><strong>Best For</strong></td>
                      <td>Modern applications</td>
                      <td>Legacy PHP apps</td>
                    </tr>
                  </tbody>
                </table>
                <p><strong>Recommendation:</strong> Use JWT Mode for all new applications. Legacy Mode is for backward compatibility only.</p>
              </div>
            </div>
          </div>

          <!-- FAQ 4 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                Do I need to implement a User Handler API?
              </button>
            </h2>
            <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>For JWT Mode: Yes, it's required.</strong></p>
                <p>The User Handler API allows SSO-Authen to:</p>
                <ul>
                  <li>Create or update users in your application's database</li>
                  <li>Assign roles based on your business logic</li>
                  <li>Return application-specific user data to be included in the JWT</li>
                </ul>
                <p><strong>For Legacy Mode: No.</strong></p>
                <p>Legacy Mode creates sessions directly without calling your API.</p>
              </div>
            </div>
          </div>

          <!-- FAQ 5 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                How do I register a new client application?
              </button>
            </h2>
            <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <ol>
                  <li>Login to Admin Panel: <code>https://sso.oas.psu.ac.th/admin/public/</code></li>
                  <li>Go to <strong>Client Management</strong></li>
                  <li>Click <strong>"Add New Client"</strong></li>
                  <li>Fill in required information:
                    <ul>
                      <li>Client ID (unique identifier)</li>
                      <li>Client Name</li>
                      <li>Redirect URI (callback URL)</li>
                      <li>User Handler Endpoint (for JWT Mode)</li>
                    </ul>
                  </li>
                  <li>Save and note down the <code>client_id</code> and <code>api_secret_key</code></li>
                </ol>
              </div>
            </div>
          </div>

          <!-- FAQ 6 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq6">
                Can I use SSO-Authen with my mobile app?
              </button>
            </h2>
            <div id="faq6" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>Yes!</strong> Mobile apps can use SSO-Authen through:</p>
                <ol>
                  <li><strong>In-App Browser:</strong> Open SSO login URL in WebView/Safari/Chrome Custom Tabs</li>
                  <li><strong>Deep Linking:</strong> Configure callback URL as a deep link to return to your app</li>
                  <li><strong>Backend Proxy:</strong> Use your backend API to handle SSO flow and return JWT to mobile app</li>
                </ol>
                <p>Mobile apps receive the same JWT token and can validate it like any other client.</p>
              </div>
            </div>
          </div>

          <!-- FAQ 7 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq7">
                How long are JWT tokens valid?
              </button>
            </h2>
            <div id="faq7" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>Default: 2 hours (7200 seconds)</strong></p>
                <p>You can configure this in SSO-Authen's <code>config.php</code>:</p>
                <pre><code>define('JWT_EXPIRATION', 7200); // seconds</code></pre>
                <p><strong>Recommendations:</strong></p>
                <ul>
                  <li><strong>Short-lived apps (1-2 hours):</strong> Default setting is fine</li>
                  <li><strong>Long-running apps:</strong> Implement token refresh mechanism</li>
                  <li><strong>High-security apps:</strong> Use shorter expiration (30-60 minutes)</li>
                </ul>
                <p>When a token expires, users must re-authenticate (which may be automatic if provider session is still active).</p>
              </div>
            </div>
          </div>

          <!-- FAQ 8 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq8">
                Can I customize the user data in JWT tokens?
              </button>
            </h2>
            <div id="faq8" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>Yes!</strong> You have full control over JWT payload through your User Handler API.</p>
                <p>SSO-Authen includes whatever data you return from the User Handler:</p>
                <pre><code class="language-javascript">// In your User Handler API
return res.json({
  id: user.id,
  email: user.email,
  name: user.name,
  role: user.role,
  department: user.department,  // Custom field
  permissions: user.permissions, // Custom field
  avatar: user.avatar_url        // Custom field
});

// These will all be included in the JWT token</code></pre>
                <div class="alert alert-warning mt-2">
                  <strong>Note:</strong> Don't include sensitive data (passwords, credit cards, etc.) in JWT tokens as they can be decoded by anyone.
                </div>
              </div>
            </div>
          </div>

          <!-- FAQ 9 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq9">
                What happens when I change the JWT secret?
              </button>
            </h2>
            <div id="faq9" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p>When you update the JWT secret in SSO-Authen:</p>
                <ol>
                  <li><strong>All existing JWT tokens become invalid immediately</strong></li>
                  <li>Users with old tokens will get "Invalid signature" errors</li>
                  <li>They must re-authenticate to get new tokens</li>
                  <li>Config.php is automatically backed up by admin panel</li>
                </ol>
                <p><strong>Best practices:</strong></p>
                <ul>
                  <li>Schedule secret rotation during maintenance windows</li>
                  <li>Notify all client applications to update their JWT_SECRET</li>
                  <li>Test with one client app before rolling out to all</li>
                  <li>Keep backup of old secret temporarily for rollback</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- FAQ 10 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq10">
                Does logging out from my app log out from the OIDC provider?
              </button>
            </h2>
            <div id="faq10" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>No.</strong> The logout flow works in layers:</p>
                <ol>
                  <li><strong>Your Application:</strong> Clears local session/JWT (your responsibility)</li>
                  <li><strong>SSO-Authen:</strong> Destroys SSO-Authen session (when you call /public/logout.php)</li>
                  <li><strong>OIDC Provider:</strong> Session remains active (user must logout separately)</li>
                </ol>
                <p>This means if a user logs out and immediately tries to login again, they may be automatically logged back in without entering credentials (because the provider session is still active).</p>
                <p><strong>To implement full logout:</strong> Contact your OIDC provider for their end_session_endpoint and chain the logout calls.</p>
              </div>
            </div>
          </div>

          <!-- FAQ 11 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq11">
                Can I use SSO-Authen with multiple OIDC providers?
              </button>
            </h2>
            <div id="faq11" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>Currently: One provider per SSO-Authen instance</strong></p>
                <p>SSO-Authen is configured to use a single OIDC provider (specified in config.php). However, you can:</p>
                <ol>
                  <li><strong>Deploy multiple instances:</strong> Run separate SSO-Authen instances for different providers</li>
                  <li><strong>Switch providers:</strong> Change the provider configuration in config.php</li>
                  <li><strong>Custom implementation:</strong> Modify the code to support provider selection (requires development)</li>
                </ol>
              </div>
            </div>
          </div>

          <!-- FAQ 12 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq12">
                How do I handle user roles and permissions?
              </button>
            </h2>
            <div id="faq12" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>SSO-Authen only handles authentication, not authorization.</strong></p>
                <p>Role assignment is YOUR responsibility through the User Handler API:</p>
                <pre><code class="language-php">// Example: Assign roles based on email domain
if (str_ends_with($email, '@admin.psu.ac.th')) {
    $role = 'admin';
} elseif (str_ends_with($email, '@psu.ac.th')) {
    $role = 'staff';
} else {
    $role = 'guest';
}

// Or: Check against admin database
$admin = AdminUser::where('email', $email)->first();
$role = $admin ? $admin->role : 'user';

// Or: Query HR system
$hrData = Http::get("https://hr.api/user/$email");
$role = $hrData['position'];</code></pre>
                <p>The role is then included in the JWT and your application can use it for access control.</p>
              </div>
            </div>
          </div>

          <!-- FAQ 13 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq13">
                Is SSO-Authen production-ready?
              </button>
            </h2>
            <div id="faq13" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>Yes,</strong> but ensure you:</p>
                <div class="row">
                  <div class="col-md-6">
                    <h6>Security Checklist:</h6>
                    <ul>
                      <li>âœ“ Change default admin password</li>
                      <li>âœ“ Use HTTPS for all endpoints</li>
                      <li>âœ“ Set strong JWT_SECRET (32+ chars)</li>
                      <li>âœ“ Configure database backups</li>
                      <li>âœ“ Restrict admin panel access</li>
                      <li>âœ“ Use environment variables for secrets</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6>Operations Checklist:</h6>
                    <ul>
                      <li>âœ“ Setup error logging</li>
                      <li>âœ“ Monitor authentication logs</li>
                      <li>âœ“ Configure automated backups</li>
                      <li>âœ“ Document recovery procedures</li>
                      <li>âœ“ Test failover scenarios</li>
                      <li>âœ“ Setup monitoring/alerts</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- FAQ 14 -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq14">
                Where can I get help or report bugs?
              </button>
            </h2>
            <div id="faq14" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                <p><strong>Support Options:</strong></p>
                <ul>
                  <li><strong>Documentation:</strong> This API documentation covers most use cases</li>
                  <li><strong>Examples:</strong> Check <code>/examples/</code> directory for working code</li>
                  <li><strong>System Administrator:</strong> Contact your SSO-Authen administrator</li>
                  <li><strong>Troubleshooting:</strong> See the Troubleshooting section above</li>
                </ul>
              </div>
            </div>
          </div>

        </div>

        <div class="alert alert-info mt-5">
          <h5><i class="fas fa-question-circle me-2"></i>Have more questions?</h5>
          <p class="mb-0">Contact your system administrator (E-mail: <a href="mailto:kittisak.k@psu.ac.th">kittisak.k@psu.ac.th</a>) or check the SSO-Authen repository (<a href="https://github.com/Noung/sso-authen-3" target="_blank">https://github.com/Noung/sso-authen-3</a>) for additional documentation and updates.</p>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("show");
      }

      function showSection(sectionId) {
        document.querySelectorAll(".section-content").forEach((section) => {
          section.classList.remove("active");
        });
        document.getElementById(sectionId).classList.add("active");

        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector(`a[href="#${sectionId}"]`)
          .classList.add("active");

        // Render Mermaid charts when section becomes visible
        if (typeof mermaid !== "undefined") {
          console.log("Rendering Mermaid charts for section:", sectionId);
          setTimeout(() => {
            try {
              // Find all mermaid diagrams in the visible section
              const mermaidElements = document.querySelectorAll(`#${sectionId} .mermaid`);
              
              mermaidElements.forEach((element) => {
                // Remove data-processed attribute to force re-render
                element.removeAttribute('data-processed');
                
                // Clear any existing SVG
                const existingSvg = element.querySelector('svg');
                if (existingSvg) {
                  existingSvg.remove();
                }
              });
              
              // Re-render all mermaid diagrams in this section
              if (mermaidElements.length > 0) {
                mermaid.run({
                  querySelector: `#${sectionId} .mermaid`
                });
                console.log("Mermaid charts rendered successfully");
              }
            } catch (error) {
              console.error("Error rendering Mermaid charts:", error);
            }
          }, 100);
        }

        // Close mobile sidebar
        if (window.innerWidth < 768) {
          document.getElementById("sidebar").classList.remove("show");
        }
      }

      function showCodeTab(tabId) {
        // Find parent code-example
        const button = event.target;
        const codeExample = button.closest('.code-example');
        
        // Update tabs
        codeExample.querySelectorAll(".code-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        button.classList.add("active");

        // Update code blocks
        codeExample.querySelectorAll(".code-block").forEach((block) => {
          block.classList.remove("active");
        });
        codeExample.querySelector(`#${tabId}`).classList.add("active");
      }

      function filterDocumentation() {
        const searchTerm = document
          .getElementById("docsSearch")
          .value.toLowerCase();
        const navSections = document.querySelectorAll(".nav-section");

        navSections.forEach((section) => {
          const navLinks = section.querySelectorAll(".nav-link");
          let sectionHasVisibleItems = false;

          navLinks.forEach((link) => {
            const linkText = link.textContent.toLowerCase();
            if (searchTerm === "" || linkText.includes(searchTerm)) {
              link.style.display = "block";
              sectionHasVisibleItems = true;
            } else {
              link.style.display = "none";
            }
          });

          if (sectionHasVisibleItems || searchTerm === "") {
            section.style.display = "block";
          } else {
            section.style.display = "none";
          }
        });
      }

      // Initialize Mermaid on page load
      document.addEventListener('DOMContentLoaded', function() {
        // Render mermaid diagrams in the active section
        if (typeof mermaid !== "undefined") {
          console.log('Mermaid ready for rendering');
          
          // Initial render for visible section
          setTimeout(() => {
            const activeSection = document.querySelector('.section-content.active');
            if (activeSection) {
              const mermaidElements = activeSection.querySelectorAll('.mermaid');
              if (mermaidElements.length > 0) {
                mermaid.run({
                  querySelector: '.section-content.active .mermaid'
                });
                console.log('Initial Mermaid charts rendered');
              }
            }
          }, 100);
        }
      });
    </script>
  </body>
</html>
